import{vec2 as t,vec3 as e,mat4 as s,mat2d as i,quat as r,vec4 as n}from"https://unpkg.com/gl-matrix@3/esm/index.js";import{Option as o,none as a,iter as h,some as u}from"https://unpkg.com/@aicacia/core@0/browser/index.js";import{v4 as c}from"https://unpkg.com/uuid@8/dist/esm-browser/index.js";import{isJSONArray as d}from"https://unpkg.com/@aicacia/json@0/browser/index.js";import{Pool as l}from"https://unpkg.com/@aicacia/pool@0/browser/index.js";var g={exports:{}};!function(t){var e=Object.prototype.hasOwnProperty,s="~";function i(){}function r(t,e,s){this.fn=t,this.context=e,this.once=s||!1}function n(t,e,i,n,o){if("function"!=typeof i)throw new TypeError("The listener must be a function");var a=new r(i,n||t,o),h=s?s+e:e;return t._events[h]?t._events[h].fn?t._events[h]=[t._events[h],a]:t._events[h].push(a):(t._events[h]=a,t._eventsCount++),t}function o(t,e){0==--t._eventsCount?t._events=new i:delete t._events[e]}function a(){this._events=new i,this._eventsCount=0}Object.create&&(i.prototype=Object.create(null),(new i).__proto__||(s=!1)),a.prototype.eventNames=function(){var t,i,r=[];if(0===this._eventsCount)return r;for(i in t=this._events)e.call(t,i)&&r.push(s?i.slice(1):i);return Object.getOwnPropertySymbols?r.concat(Object.getOwnPropertySymbols(t)):r},a.prototype.listeners=function(t){var e=s?s+t:t,i=this._events[e];if(!i)return[];if(i.fn)return[i.fn];for(var r=0,n=i.length,o=new Array(n);r<n;r++)o[r]=i[r].fn;return o},a.prototype.listenerCount=function(t){var e=s?s+t:t,i=this._events[e];return i?i.fn?1:i.length:0},a.prototype.emit=function(t,e,i,r,n,o){var a=s?s+t:t;if(!this._events[a])return!1;var h,u,c=this._events[a],d=arguments.length;if(c.fn){switch(c.once&&this.removeListener(t,c.fn,void 0,!0),d){case 1:return c.fn.call(c.context),!0;case 2:return c.fn.call(c.context,e),!0;case 3:return c.fn.call(c.context,e,i),!0;case 4:return c.fn.call(c.context,e,i,r),!0;case 5:return c.fn.call(c.context,e,i,r,n),!0;case 6:return c.fn.call(c.context,e,i,r,n,o),!0}for(u=1,h=new Array(d-1);u<d;u++)h[u-1]=arguments[u];c.fn.apply(c.context,h)}else{var l,g=c.length;for(u=0;u<g;u++)switch(c[u].once&&this.removeListener(t,c[u].fn,void 0,!0),d){case 1:c[u].fn.call(c[u].context);break;case 2:c[u].fn.call(c[u].context,e);break;case 3:c[u].fn.call(c[u].context,e,i);break;case 4:c[u].fn.call(c[u].context,e,i,r);break;default:if(!h)for(l=1,h=new Array(d-1);l<d;l++)h[l-1]=arguments[l];c[u].fn.apply(c[u].context,h)}}return!0},a.prototype.on=function(t,e,s){return n(this,t,e,s,!1)},a.prototype.once=function(t,e,s){return n(this,t,e,s,!0)},a.prototype.removeListener=function(t,e,i,r){var n=s?s+t:t;if(!this._events[n])return this;if(!e)return o(this,n),this;var a=this._events[n];if(a.fn)a.fn!==e||r&&!a.once||i&&a.context!==i||o(this,n);else{for(var h=0,u=[],c=a.length;h<c;h++)(a[h].fn!==e||r&&!a[h].once||i&&a[h].context!==i)&&u.push(a[h]);u.length?this._events[n]=1===u.length?u[0]:u:o(this,n)}return this},a.prototype.removeAllListeners=function(t){var e;return t?(e=s?s+t:t,this._events[e]&&o(this,e)):(this._events=new i,this._eventsCount=0),this},a.prototype.off=a.prototype.removeListener,a.prototype.addListener=a.prototype.on,a.prefixed=s,a.EventEmitter=a,t.exports=a}(g);class p{constructor(){this.constructorToTypeId=new Map,this.typeIdToConstructor=new Map}getByConstructor(t){return o.from(this.constructorToTypeId.get(t)).map((e=>{const s=this.typeIdToConstructor.get(e);if(t===s)return e;throw new Error(`${t} and ${s} are using the same typeId ${e}`)})).unwrapOrElse((()=>{const e=t.getTypeId();return this.constructorToTypeId.set(t,e),this.typeIdToConstructor.set(e,t),e}))}getById(t){return o.from(this.typeIdToConstructor.get(t))}}const m=new p;class f extends g.exports.EventEmitter{static toString(){return this.getTypeId()}static getTypeId(){return this.typeId||this.name}static isToFromJSONEnabled(){return!!this.toFromJSONEnabled}static getConstructorFromJSON(t){return m.getById(t.typeId).expect((()=>`Failed to get class ${t.typeId} from globalJSONClassRegistry make sure the Component was added`))}static newFromJSON(t){return(new(this.getConstructorFromJSON(t))).fromJSON(t)}getConstructor(){return Object.getPrototypeOf(this).constructor}toJSON(){return{typeId:m.getByConstructor(this.getConstructor())}}fromJSON(t){return this}}f.toFromJSONEnabled=!0;class v extends f{constructor(){super(...arguments),this.scene=a()}static getManagerPriority(){return this.managerPriority}UNSAFE_setScene(t){return this.scene.replace(t),this}UNSAFE_removeScene(){return this.scene.clear(),this}getScene(){return this.scene}getConstructor(){return Object.getPrototypeOf(this).constructor}getManagerPriority(){return Object.getPrototypeOf(this).constructor.getManagerPriority()}getPlugin(t){return this.getScene().flatMap((e=>e.getPlugin(t)))}getRequiredPlugin(t){return this.getPlugin(t).expect((()=>`${this.getConstructor()} required ${t} Plugin`))}getManager(t){return this.getScene().flatMap((e=>e.getManager(t)))}getRequiredManager(t){return this.getManager(t).expect((()=>`${this.getConstructor()} required ${t} Manager`))}onAdd(){return this}onRemove(){return this}}v.managerPriority=0;class S extends v{constructor(){super(...arguments),this.components=[],this.sortFunction=(t,e)=>t.getRequiredEntity().getDepth()-e.getRequiredEntity().getDepth()}getComponents(){return this.components}addComponent(t){return this.components.push(t),this}removeComponent(t){const e=this.components.indexOf(t);return-1!==e&&this.components.splice(e,1),this}isEmpty(){return 0===this.components.length}sort(){return this.components.sort(this.sortFunction),this}onInit(){for(const t of this.components)t.onInit();return this}onUpdate(){for(const t of this.components)t.onUpdate();return this}onAfterUpdate(){for(const t of this.components)t.onAfterUpdate();return this}}class x extends f{constructor(){super(...arguments),this.entity=a(),this.manager=a()}static getManagerConstructor(){if(!this.Manager)throw new Error(this+" invalid Manager `"+this.Manager+"` "+this);return this.Manager}static getRequiredComponents(){return this.requiredComponents}static getRequiredPlugins(){return this.requiredPlugins}getManagerConstructor(){return Object.getPrototypeOf(this).constructor.getManagerConstructor()}getRequiredComponents(){return Object.getPrototypeOf(this).constructor.requiredComponents}getRequiredPlugins(){return Object.getPrototypeOf(this).constructor.requiredPlugins}getComponent(t){return this.getEntity().flatMap((e=>e.getComponent(t)))}getRequiredComponent(t){return this.getComponent(t).expect((()=>`${this.getConstructor()} Component requires ${t} Component`))}getPlugin(t){return this.getScene().flatMap((e=>e.getPlugin(t)))}getRequiredPlugin(t){return this.getPlugin(t).expect((()=>`${this.getConstructor()} Component requires ${t} Plugin`))}UNSAFE_setEntity(t){return this.entity.replace(t),this}UNSAFE_removeEntity(){return this.entity.clear(),this}getEntity(){return this.entity}getRequiredEntity(){return this.getEntity().expect((()=>`${this.getConstructor()} Component requires an Entity`))}getScene(){return this.entity.flatMap((t=>t.getScene()))}getRequiredScene(){return this.getScene().expect((()=>`${this.getConstructor()} Component requires a Scene`))}UNSAFE_setManager(t){return this.manager.replace(t),this}UNSAFE_removeManager(){return this.manager.clear(),this}getManager(){return this.manager}getRequiredManager(){return this.getManager().expect((()=>`${this.getConstructor()} Component is not part of a Manager ${Object.getPrototypeOf(this).getManagerConstructor()} Manager`))}getSceneManager(t){return this.getScene().flatMap((e=>e.getManager(t)))}getRequiredSceneManager(t){return this.getSceneManager(t).expect((()=>`${this.getConstructor()} Component requires ${Object.getPrototypeOf(this).getManagerConstructor()} Manager`))}onInit(){return this}onDetach(){return this}onAdd(){return this}onRemove(){return this}onUpdate(){return this}onAfterUpdate(){return this}}x.Manager=S,x.requiredComponents=[],x.requiredPlugins=[];class y extends x{constructor(){super(...arguments),this.renderable=!0}getRenderable(){return this.renderable}setRenderable(t=!0){return this.renderable=t,this}}class N extends S{onInit(){return this}onUpdate(){return this}onAfterUpdate(){return this}}class P extends N{}const w=t.create(),A=e.create();class E extends y{constructor(){super(...arguments),this.needsUpdate=!0,this.localNeedsUpdate=!0}static getParentTransform(t){return t.getParent().andThen(E.getTransform)}static getTransform(t){}static getRequiredTransform(t){return E.getTransform(t).expect("Entity required a TransformComponent")}onDetach(){return this.setNeedsUpdate()}getParentTransform(){return this.getEntity().flatMap(E.getParentTransform)}setNeedsUpdate(t=!0){return this.setLocalNeedsUpdate(t),t!==this.needsUpdate&&(this.needsUpdate=t,this.getEntity().ifSome((e=>{for(const s of e.getChildren())for(const e of s.getComponentsInstanceOf(E))e.setNeedsUpdate(t)}))),this}getNeedsUpdate(){return this.needsUpdate}setLocalNeedsUpdate(t=!0){return this.localNeedsUpdate=t,this}getLocalNeedsUpdate(){return this.localNeedsUpdate}updateLocalMatrixIfNeeded(){return this.localNeedsUpdate?(this.localNeedsUpdate=!1,this.updateLocalMatrix()):this}updateMatrixIfNeeded(){return this.needsUpdate?(this.needsUpdate=!1,this.updateMatrix()):this}translate2(e){const s=this.getLocalPosition2(w);return t.add(s,s,e),this.setLocalPosition2(s)}translate3(t){const s=this.getLocalPosition3(A);return e.add(s,s,t),this.setLocalPosition3(s)}scale2(e){const s=this.getLocalScale2(w);return t.mul(s,s,e),this.setLocalPosition2(s)}scale3(t){const s=this.getLocalScale3(A);return e.mul(s,s,t),this.setLocalPosition3(s)}}E.Manager=P;class O{constructor(){this.min=t.fromValues(1/0,1/0),this.max=t.fromValues(-1/0,-1/0)}static create(){return new O}static fromValues(t,e){return O.set(O.create(),t,e)}static set(t,e,s){return O.setMin(t,e),O.setMax(t,s),t}static setMin(e,s){return t.copy(e.min,s),e}static setMax(e,s){return t.copy(e.max,s),e}static identity(e){return t.set(e.min,1/0,1/0),t.set(e.max,-1/0,-1/0),e}static expandPoint(e,s,i){return t.min(e.min,s.min,i),t.max(e.max,s.max,i),e}static union(e,s,i){return t.min(e.min,s.min,i.min),t.max(e.max,s.max,i.max),e}static intersects(t,e){return!this.notIntersects(t,e)}static notIntersects(t,e){return t.max[0]<e.min[0]||t.min[0]>e.max[0]||t.max[1]<e.min[1]||t.min[1]>e.max[1]}}const M=Math.PI/180,C=180/Math.PI,R=.5*Math.PI,L=2*Math.PI,U=1e-6;function b(t,e,s,i){const r=s[0],n=s[1],o=Math.cos(i),a=Math.sin(i);return t[0]=o*r,t[1]=a*r,t[2]=-a*n,t[3]=o*n,t[4]=e[0],t[5]=e[1],t}const q=t.create();function I(e,s){return t.set(e,t.len(t.set(q,s[0],s[1])),t.len(t.set(q,s[2],s[3])))}function _(e,s,i){return t.set(s,e[4],e[5]),I(i,e),F(e)}function F(t){return Math.atan2(t[2],t[0])}function j(t,e){return t[0]=Math.cos(e),t[1]=Math.sin(e),t}function J(t){const e=t[0],s=t[1],i=Math.atan2(s,e);return s<0?L+i:i}const H=t.create();function T(e){const s=t.copy(H,e),i=s[0];return s[0]=s[1],s[1]=i,J(s)}function B(e,s){const i=s[1]<e[1]?-1:1;return Math.acos(t.dot(e,s)/(t.len(e)*t.len(s)))*i}function z(t){return t<0?-1:1}function k(t,e,s){return t<e?e:t>s?s:t}function D(t){return Math.atan2(t[1],t[0])}function W(t,e){return t[0]=Math.cos(e),t[1]=Math.sin(e),t}function $(e,s,i){const r=t.squaredLength(i),n=t.dot(s,i);return t.scale(e,i,n/r)}function V(t){return t*C}function Y(t){return t*M}function X(t,e){return Math.abs(t-e)<=1e-6*Math.max(1,Math.abs(t),Math.abs(e))}function Z(t){return`#${(255*t[0]|0).toString(16)}${(255*t[1]|0).toString(16)}${(255*t[2]|0).toString(16)}`}function Q(t){return`rgb(${255*t[0]}, ${255*t[1]}, ${255*t[2]})`}function K(t){return`rgba(${255*t[0]}, ${255*t[1]}, ${255*t[2]}, ${t[3]})`}function G(t,e){return s.set(t,e[0],e[1],0,e[4],e[2],e[3],0,e[5],0,0,1,0,0,0,0,1)}function tt(t,e){return i.set(t,e[0],e[1],e[4],e[5],e[13],e[14])}const et=[t.create(),t.create(),t.create(),t.create()];function st(e,s,i,r){const n=et,o=.5*r[0],a=.5*r[1];return O.identity(e),t.set(n[0],s[0]-o,s[1]-a),t.set(n[1],s[0]-o,s[1]+a),t.set(n[2],s[0]+o,s[1]+a),t.set(n[3],s[0]+o,s[1]-a),n.forEach((r=>{t.rotate(r,r,s,i),O.expandPoint(e,e,r)})),e}const it=t.create(),rt=e.fromValues(0,0,1),nt=i.create();class ot extends E{constructor(){super(...arguments),this.localPosition=t.create(),this.localScale=t.fromValues(1,1),this.localRotation=0,this.localMatrix=i.create(),this.position=t.create(),this.scale=t.fromValues(1,1),this.rotation=0,this.matrix=i.create()}getLocalPosition2(e){return t.copy(e,this.getLocalPosition())}getLocalPosition3(t){const e=this.getLocalPosition();return t[0]=e[0],t[1]=e[1],t}setLocalPosition2(t){return this.setLocalPosition(t)}setLocalPosition3(e){return this.setLocalPosition(t.set(it,e[0],e[1]))}getPosition2(e){return t.copy(e,this.getPosition())}getPosition3(t){const e=this.getPosition();return t[0]=e[0],t[1]=e[1],t}getLocalRotationZ(){return this.getLocalRotation()}getLocalRotationQuat(t){return r.fromEuler(t,0,0,this.getLocalRotation())}setLocalRotationZ(t){return this.setLocalRotation(t)}setLocalRotationQuat(t){return this.setLocalRotation(r.getAxisAngle(rt,t))}getRotationZ(){return this.getRotation()}getRotationQuat(t){return r.fromEuler(t,0,0,this.getRotation())}getLocalScale2(e){return t.copy(e,this.getLocalScale())}getLocalScale3(t){const e=this.getLocalScale();return t[0]=e[0],t[1]=e[1],t}setLocalScale2(t){return this.setLocalScale(t)}setLocalScale3(e){return this.setLocalScale(t.set(it,e[0],e[1]))}getScale2(e){return t.copy(e,this.getScale())}getScale3(t){const e=this.getScale();return t[0]=e[0],t[1]=e[1],t}setLocalPosition(e){return t.copy(this.localPosition,e),this.setNeedsUpdate()}getPosition(){return this.updateMatrixIfNeeded().position}getLocalPosition(){return this.localPosition}setLocalScale(e){return t.copy(this.localScale,e),this.setNeedsUpdate()}getScale(){return this.updateMatrixIfNeeded().scale}getLocalScale(){return this.localScale}setLocalRotation(t){return this.localRotation=t,this.setNeedsUpdate()}getRotation(){return this.updateMatrixIfNeeded().rotation}getLocalRotation(){return this.localRotation}getMatrix(){return this.updateMatrixIfNeeded().matrix}getLocalMatrix(){return this.updateLocalMatrixIfNeeded().localMatrix}updateLocalMatrix(){return b(this.localMatrix,this.localPosition,this.localScale,this.localRotation),this}updateMatrix(){return this.updateLocalMatrixIfNeeded().getParentTransform().mapOrElse((t=>{i.mul(this.matrix,t.getMatrix2d(nt),this.localMatrix),this.rotation=_(this.matrix,this.position,this.scale)}),(()=>{i.copy(this.matrix,this.localMatrix),t.copy(this.position,this.localPosition),t.copy(this.scale,this.localScale),this.rotation=this.localRotation})),this}getMatrix4(t){return G(t,this.getMatrix())}getMatrix2d(t){return i.copy(t,this.getMatrix())}getLocalMatrix4(t){return G(t,this.getLocalMatrix())}getLocalMatrix2d(t){return i.copy(t,this.getLocalMatrix())}toLocalPosition(e,s){return t.sub(e,s,this.getPosition())}lookAt(t){return this.setLocalRotation(B(this.localPosition,this.toLocalPosition(it,t))-R)}toJSON(){return Object.assign(Object.assign({},super.toJSON()),{localPosition:this.localPosition,localScale:this.localScale,localRotation:this.localRotation})}fromJSON(t){return super.fromJSON(t).setLocalPosition(t.localPosition).setLocalScale(t.localScale).setLocalRotation(t.localRotation)}}const at=s.create(),ht=r.create(),ut=e.create(),ct=e.fromValues(0,0,1);class dt extends E{constructor(){super(...arguments),this.localPosition=e.create(),this.localScale=e.fromValues(1,1,1),this.localRotation=r.identity(r.create()),this.localMatrix=s.create(),this.position=e.create(),this.scale=e.fromValues(1,1,1),this.rotation=r.identity(r.create()),this.matrix=s.create()}getLocalPosition3(t){return e.copy(t,this.getLocalPosition())}getLocalPosition2(t){const e=this.getLocalPosition();return t[0]=e[0],t[1]=e[1],t}setLocalPosition2(t){return this.setLocalPosition(e.set(ut,t[0],t[1],this.localPosition[2]))}setLocalPosition3(t){return this.setLocalPosition(t)}getPosition3(t){return e.copy(t,this.getPosition())}getPosition2(t){const e=this.getPosition();return t[0]=e[0],t[1]=e[1],t}getLocalRotationQuat(t){return r.copy(t,this.localRotation)}getLocalRotationZ(){return r.getAxisAngle(ct,this.localRotation)}setLocalRotationZ(t){const e=r.copy(ht,this.getLocalRotation());return r.rotateZ(e,e,t),this.setLocalRotation(e)}setLocalRotationQuat(t){return this.setLocalRotation(t)}getRotationQuat(t){return r.copy(t,this.getRotation())}getRotationZ(){return r.getAxisAngle(ct,this.getRotation())}getLocalScale3(t){return e.copy(t,this.getLocalScale())}getLocalScale2(t){const e=this.getLocalScale();return t[0]=e[0],t[1]=e[1],t}setLocalScale2(t){return this.setLocalScale(e.set(ut,t[0],t[1],this.localScale[2]))}setLocalScale3(t){return this.setLocalScale(t)}getScale3(t){return e.copy(t,this.getScale())}getScale2(t){const e=this.getScale();return t[0]=e[0],t[1]=e[1],t}setLocalPosition(t){return e.copy(this.localPosition,t),this.setNeedsUpdate()}getPosition(){return this.updateMatrixIfNeeded().position}getLocalPosition(){return this.localPosition}setLocalScale(t){return e.copy(this.localScale,t),this.setNeedsUpdate()}getScale(){return this.updateMatrixIfNeeded().scale}getLocalScale(){return this.localScale}setLocalRotation(t){return r.copy(this.localRotation,t),this.setNeedsUpdate()}getRotation(){return this.updateMatrixIfNeeded().rotation}getLocalRotation(){return this.localRotation}getMatrix(){return this.updateMatrixIfNeeded().matrix}getLocalMatrix(){return this.updateLocalMatrixIfNeeded().localMatrix}updateLocalMatrix(){return s.fromRotationTranslationScale(this.localMatrix,this.localRotation,this.localPosition,this.localScale),this}updateMatrix(){return this.updateLocalMatrixIfNeeded().getParentTransform().mapOrElse((t=>{s.mul(this.matrix,t.getMatrix4(at),this.localMatrix),s.getRotation(this.rotation,this.matrix),s.getScaling(this.scale,this.matrix),s.getTranslation(this.position,this.matrix)}),(()=>{s.copy(this.matrix,this.localMatrix),e.copy(this.position,this.localPosition),e.copy(this.scale,this.localScale),r.copy(this.rotation,this.localRotation)})),this}getMatrix4(t){return s.copy(t,this.getMatrix())}getMatrix2d(t){return tt(t,this.getMatrix())}getLocalMatrix4(t){return s.copy(t,this.getLocalMatrix())}getLocalMatrix2d(t){return tt(t,this.getLocalMatrix())}toLocalPosition(t,s){return e.sub(t,s,this.getPosition())}lookAt(t,e=ct){return s.getRotation(this.localRotation,s.targetTo(at,this.localPosition,this.toLocalPosition(ut,t),e)),this.setNeedsUpdate()}toJSON(){return Object.assign(Object.assign({},super.toJSON()),{localPosition:this.localPosition,localScale:this.localScale,localRotation:this.localRotation})}fromJSON(t){return super.fromJSON(t).setLocalPosition(t.localPosition).setLocalScale(t.localScale).setLocalRotation(t.localRotation)}}class lt extends N{constructor(){super(...arguments),this.active=a()}setActive(t){if(!t.getManager().map((t=>t===this)).unwrapOr(!1))throw new Error("Camera2DManager.setActive(camera: Camera2D): cannot set active if camera is not in manager");return this.active.replace(t),this}getActive(){return this.active}getRequiredActive(){return this.getActive().expect("Expected an Active Camera")}addComponent(t){return super.addComponent(t),this.active.isNone()&&this.active.replace(t),this}removeComponent(t){return super.removeComponent(t),this.active.ifSome((e=>{e===t&&this.active.clear()})),this}}const gt=i.create(),pt=t.create(),mt=[t.create(),t.create(),t.create(),t.create()];class ft extends y{constructor(){super(...arguments),this.width=1,this.height=1,this.aspect=1,this.size=1,this.minSize=Number.EPSILON,this.maxSize=1/0,this.projection=i.identity(i.create()),this.view=i.identity(i.create()),this.needsUpdate=!0,this.background=n.create()}getBackground(){return this.background}setBackground(t){return n.copy(this.background,t),this}set(t,e){return t!==this.width||e!==this.height?(this.width=t,this.height=e,this.aspect=t/e,this.setNeedsUpdate()):this}getWidth(){return this.width}setWidth(t){return this.set(t,this.height)}getHeight(){return this.height}setHeight(t){return this.set(this.width,t)}getAspect(){return this.aspect}getSize(){return this.size}setSize(t){return this.size=t<this.minSize?this.minSize:t>this.maxSize?this.maxSize:t,this.setNeedsUpdate()}getMinSize(){return this.minSize}setMinSize(t){return this.minSize=t,this.setNeedsUpdate()}getMaxSize(){return this.minSize}setMaxSize(t){return this.maxSize=t,this.setNeedsUpdate()}setZoom(e){return this.getEntity().flatMap(E.getTransform).ifSome((s=>s.setLocalScale2(t.set(pt,e,e)))),this}getZoom(){return this.getEntity().flatMap(E.getTransform).map((e=>t.len(I(pt,e.getMatrix2d(gt)))*this.size)).unwrapOr(this.size)}getView(){return this.getEntity().flatMap(E.getTransform).ifSome((t=>i.invert(this.view,t.getMatrix2d(gt)))),this.view}getProjection(){return this.updateProjectionIfNeeded().projection}getAABB2(e){const s=gt,r=mt;O.identity(e),t.set(r[0],0,0),t.set(r[1],this.width,0),t.set(r[2],this.width,this.height),t.set(r[3],0,this.height),i.mul(s,this.projection,this.view),i.invert(s,s);for(const i of r)i[0]=i[0]/this.width*2-1,i[1]=i[1]/this.height*-2+1,t.transformMat2d(i,i,s),O.expandPoint(e,e,i);return e}setNeedsUpdate(t=!0){return this.needsUpdate=t,this}updateProjectionIfNeeded(){return this.needsUpdate?this.updateProjection():this}isActive(){return this.getRequiredManager().getActive().map((t=>t===this)).unwrapOr(!1)}setActive(){return this.getRequiredManager().setActive(this),this}updateProjection(){const t=this.getSize(),e=t*this.aspect,s=-e,r=-t,n=e-s,o=t-r,a=(e+s)/n,h=(t+r)/o;return i.set(this.projection,2/n,0,0,2/o,-a,-h),this.needsUpdate=!1,this}toRelative(e,s){return this.toWorld(e,s),t.transformMat2d(e,e,this.view),e}toWorld(e,s){const r=gt;return e[0]=s[0]/this.width*2-1,e[1]=s[1]/this.height*-2+1,i.mul(r,this.projection,this.view),i.invert(r,r),t.transformMat2d(e,e,r),e}toScreen(e,s){const r=i.mul(gt,this.projection,this.view);return t.transformMat2d(e,s,r),e[0]=.5*(e[0]+1)*this.width,e[1]=.5*(1-e[1])*this.height,e}toJSON(){return Object.assign(Object.assign({},super.toJSON()),{width:this.width,height:this.height,background:this.background})}fromJSON(t){return super.fromJSON(t).set(t.width,t.height).setBackground(t.background)}}ft.Manager=lt,ft.requiredComponents=[[ot,dt]];class vt extends f{constructor(){super(...arguments),this.uuid=c(),this.name="",this.loaded=!1,this.loading=!1}getUUID(){return this.uuid}getName(){return this.name}setName(t){return this.name=t,this}isLoaded(){return this.loaded}isLoading(){return this.loading}load(){return this.loaded?Promise.resolve():(this.loading=!0,this.loadAsset().then((()=>{this.loading=!1,this.loaded=!0,this.emit("load")})).catch((t=>{throw this.loading=!0,this.emit("load-error",t),t})))}unload(){return this.loaded?this.unloadAsset().then((()=>{this.loaded=!1,this.emit("unload")})).catch((t=>{throw this.emit("unload-error",t),t})):Promise.resolve()}toJSON(){return Object.assign(Object.assign({},super.toJSON()),{uuid:this.uuid,name:this.name})}fromJSON(t){return super.fromJSON(t),this.uuid=t.uuid,this.name=t.name,this}}function St(t,e){return t.reduce(((t,s)=>(Array.isArray(s)?s.some(e)||t.push(s):e(s)&&t.push(s),t)),[])}function xt(t){return Array.isArray(t)?`one of ${t.map(xt).join(", ")}`:t.name||t.typeId||"UnknownClass"}class yt extends f{constructor(){super(...arguments),this.scene=a()}static getPluginPriority(){return this.pluginPriority}static getRequiredPlugins(){return this.requiredPlugins}getConstructor(){return Object.getPrototypeOf(this).constructor}getPluginPriority(){return Object.getPrototypeOf(this).constructor.getPluginPriority()}getRequiredPlugins(){return Object.getPrototypeOf(this).constructor.requiredPlugins}getPlugin(t){return this.getScene().flatMap((e=>e.getPlugin(t)))}getRequiredPlugin(t){return this.getPlugin(t).expect((()=>`${this.getConstructor()} required ${t} Plugin`))}getManager(t){return this.getScene().flatMap((e=>e.getManager(t)))}getRequiredManager(t){return this.getManager(t).expect((()=>`${this.getConstructor()} required ${t} Manager`))}validateRequirements(){const t=[];for(const e of this.getRequiredScene().getPlugins()){const s=St(e.getRequiredPlugins(),(t=>!this.getRequiredScene().hasPlugin(t)));s.length>0&&t.push(...s)}if(t.length>0){const e=t.map((t=>`${xt(this.getConstructor())} Plugin requires ${xt(t)} Plugin`)).join("\n");throw new Error(e)}}UNSAFE_setScene(t){return this.scene.replace(t),this}UNSAFE_removeScene(){return this.scene.clear(),this}getScene(){return this.scene}getRequiredScene(){return this.getScene().expect((()=>`${this.getConstructor()} required a Scene`))}onInit(){return this}onAdd(){return this}onRemove(){return this}onAfterUpdate(){return this}onUpdate(){return this}}yt.pluginPriority=0,yt.requiredPlugins=[];class Nt extends yt{constructor(){super(...arguments),this.assetMap={},this.assets=[],this.loadedAssets=[],this.loadingPromises=new Map,this.unloadingPromises=new Map}find(t){return h(this.assets).find(t)}findWithName(t){return this.find((e=>e.getName()===t))}findAll(t){return h(this.assets).filter(t).toArray()}findAllWithName(t){return this.findAll((e=>e.getName()===t))}isLoading(){return this.loadingPromises.size>0}getAsset(t){return o.from(this.assetMap[t])}getAssets(){return this.assets}getLoadedAssets(){return this.loadedAssets}getLoadingAssets(){return Array.from(this.loadingPromises.keys())}getUnloadingAssets(){return Array.from(this.unloadingPromises.keys())}getUnloadedAssets(){return this.assets.filter((t=>!t.isLoaded()))}addAsset(...t){return this.addAssets(t)}addAssets(t){for(const e of t)this._addAsset(e);return this}removeAsset(...t){return this.removeAssets(t)}removeAssets(t){for(const e of t)this._removeAsset(e);return this}loadAll(){return this.loadAssets(this.getUnloadedAssets())}loadAllInBackground(){return this.loadAssetsInBackground(this.getUnloadedAssets())}loadAssetInBackground(...t){return this.loadAssetsInBackground(t)}loadAssetsInBackground(t){return this.loadAssets(t),this}unloadAssetInBackground(...t){return this.unloadAssetsInBackground(t)}unloadAssetsInBackground(t){return this.unloadAssets(t),this}loadAsset(...t){return this.loadAssets(t)}loadAssets(t){return Promise.all(t.map((t=>this._loadAsset(t))))}unloadAsset(...t){return this.unloadAssets(t)}unloadAssets(t){return Promise.all(t.map((t=>this._unloadAsset(t))))}_loadAsset(t){if(t.isLoaded())return Promise.resolve();{const e=this.loadingPromises.get(t);if(e)return e;{const e=t.load().then((()=>{this.loadingPromises.delete(t),this.loadedAssets.push(t)})).catch((e=>{throw this.loadingPromises.delete(t),e}));return this.loadingPromises.set(t,e),e}}}_unloadAsset(t){if(t.isLoaded()){const e=this.unloadingPromises.get(t);if(e)return e;{const e=t.load().then((()=>{this.unloadingPromises.delete(t),this.loadedAssets.splice(this.loadedAssets.indexOf(t),1)})).catch((e=>{throw this.unloadingPromises.delete(t),e}));return this.unloadingPromises.set(t,e),e}}return Promise.resolve()}_addAsset(t){const e=t.getUUID();return this.assetMap[e]||(this.assetMap[e]=t,this.assets.push(t)),this}_removeAsset(t){const e=t.getUUID();return this.assetMap[e]&&(delete this.assetMap[e],this.assets.splice(this.assets.indexOf(t),1)),this}toJSON(){return Object.assign(Object.assign({},super.toJSON()),{assets:this.assets.map((t=>t.toJSON()))})}fromJSON(t){return super.fromJSON(t),d(t.assets)&&this.addAssets(t.assets.map((t=>vt.newFromJSON(t)))),this}}class Pt extends vt{constructor(t,e){super(),this.json=a(),this.src=t,this.options=e}getJSON(){return this.json}loadAsset(){return fetch(this.src,this.options).then((t=>t.json())).then((t=>{this.json.replace(t)}))}unloadAsset(){return this.json.clear(),Promise.resolve()}toJSON(){return Object.assign(Object.assign({},super.toJSON()),{src:this.src,options:this.options})}fromJSON(t){return super.fromJSON(t),this.src=t.src,this.options=t.options,this}}class wt extends vt{constructor(t){super(),this.json=t}getJSON(){return this.json}loadAsset(){return Promise.resolve()}unloadAsset(){return Promise.resolve()}toJSON(){return Object.assign(Object.assign({},super.toJSON()),{json:this.json})}fromJSON(t){return super.fromJSON(t),this.json=t.json,this}}class At extends vt{}class Et extends f{constructor(){super(...arguments),this.renderer=a(),this.enabled=!0}static getRendererHandlerPriority(){return this.rendererHandlerPriority}getEnabled(){return this.enabled}setEnabled(t=!0){return this.enabled=t,this}getConstructor(){return Object.getPrototypeOf(this).constructor}getRendererHandlerPriority(){return Object.getPrototypeOf(this).constructor.getRendererHandlerPriority()}UNSAFE_setRenderer(t){return this.renderer.replace(t),this}UNSAFE_removeRenderer(){return this.renderer.clear(),this}getRenderer(){return this.renderer}getRequiredRenderer(){return this.renderer.expect(`${this.getConstructor()} expected to be added to a Renderer first`)}getScene(){return this.getRenderer().flatMap((t=>t.getScene()))}getRequiredScene(){return this.getScene().expect(`${this.getConstructor()} required scene`)}getManager(t){return this.getScene().flatMap((e=>e.getManager(t)))}getRequiredManager(t){return this.getManager(t).expect(`${this.getConstructor()} required ${t} Manager`)}getPlugin(t){return this.getScene().flatMap((e=>e.getPlugin(t)))}getRequiredPlugin(t){return this.getPlugin(t).expect(`${this.getConstructor()} required ${t} Plugin`)}onAdd(){return this}onRemove(){return this}onBeforeRender(){return this}onRender(){return this}onAfterRender(){return this}toJSON(){return Object.assign(Object.assign({},super.toJSON()),{enabled:this.enabled})}fromJSON(t){return super.fromJSON(t),this.enabled=t.enabled,this}}class Ot extends yt{constructor(){super(...arguments),this.rendererHandlers=[],this.rendererHandlerMap=new Map,this.sortRendererHandlersFunction=(t,e)=>t.getRendererHandlerPriority()-e.getRendererHandlerPriority()}getRendererHandlers(){return this.rendererHandlers}getRendererHandler(t){return o.from(this.rendererHandlerMap.get(t))}addRendererHandlers(t){for(const e of t)this._addRendererHandler(e);return this.sortRendererHandlers()}addRendererHandler(...t){return this.addRendererHandlers(t)}removeRendererHandlers(t){for(const e of t)this._removeRendererHandler(e);return this.sortRendererHandlers()}removeRendererHandler(...t){return this.removeRendererHandlers(t)}onUpdate(){for(const t of this.rendererHandlers)t.getEnabled()&&(t.onBeforeRender(),t.onRender());return this}onAfterUpdate(){for(const t of this.rendererHandlers)t.getEnabled()&&t.onAfterRender();return this}_addRendererHandler(t){const e=t.getConstructor();return this.rendererHandlerMap.has(e)||(this.rendererHandlers.push(t),this.rendererHandlerMap.set(e,t),t.UNSAFE_setRenderer(this),t.onAdd(),this.emit("add-renderer_handler",t)),this}_removeRendererHandler(t){return this.getRendererHandler(t).ifSome((e=>{this.emit("remove-renderer_handler",e),e.onRemove(),this.rendererHandlers.splice(this.rendererHandlers.indexOf(e),1),this.rendererHandlerMap.delete(t),e.UNSAFE_removeRenderer()})),this}sortRendererHandlers(){return this.rendererHandlers.sort(this.sortRendererHandlersFunction),this}toJSON(){return Object.assign(Object.assign({},super.toJSON()),{rendererHandlers:this.rendererHandlers.map((t=>t.toJSON()))})}fromJSON(t){return super.fromJSON(t),d(t.rendererHandlers)&&this.addRendererHandlers(t.rendererHandlers.map((t=>Et.newFromJSON(t)))),this}}Ot.pluginPriority=1/0;class Mt extends yt{constructor(){super(...arguments),this.scale=1,this.fixedDelta=1/60,this.frame=0,this.last=-1/60,this.current=0,this.delta=1/60,this.fps=60,this.fpsFrame=0,this.fpsLast=0,this.startTime=.001*Date.now(),this.minDelta=1e-6,this.maxDelta=1/0}getStartTime(){return this.startTime}getDelta(){return this.delta*this.scale}getRealDelta(){return this.delta*this.scale}getCurrent(){return this.current}getMinDelta(){return this.minDelta}setMinDelta(t){return this.minDelta=t,this}getMaxDelta(){return this.maxDelta}setMaxDelta(t){return this.maxDelta=t,this}getFrame(){return this.frame}getFps(){return this.fps}getScale(){return this.scale}setScale(t){return this.scale=t,this}getFixedDelta(){return this.fixedDelta*this.scale}setFixedDelta(t){return this.fixedDelta=t,this}now(){return.001*Date.now()-this.startTime}onUpdate(){return++this.frame,this.last=this.current,this.current=this.now(),this.fpsFrame++,this.fpsLast+1<this.current&&(this.fps=this.fpsFrame/(this.current-this.fpsLast),this.fpsLast=this.current,this.fpsFrame=0),this.delta=(this.current-this.last)*this.scale,this.delta=this.delta<this.minDelta?this.minDelta:this.delta>this.maxDelta?this.maxDelta:this.delta,this}toJSON(){return Object.assign(Object.assign({},super.toJSON()),{frame:this.frame,scale:this.scale,fixedDelta:this.fixedDelta})}fromJSON(t){return super.fromJSON(t),this.frame=t.frame,this.scale=t.scale,this.fixedDelta=t.fixedDelta,this}}Mt.pluginPriority=-1/0;class Ct extends yt{constructor(){super(...arguments),this.queue=[],this.swap=[]}runOnUpdate(...t){return this.queue.push(...t),this}onUpdate(){if(this.queue.length>0){const t=this.queue;this.queue=this.swap,this.swap=t;for(const e of t)e.call(this);this.swap.length=0}return this}}class Rt extends f{constructor(){super(...arguments),this.input=a()}getConstructor(){return Object.getPrototypeOf(this).constructor}UNSAFE_setInput(t){return this.input.replace(t),this}UNSAFE_removeInput(){return this.input.clear(),this}getInput(){return this.input}getRequiredInput(){return this.getInput().expect(`${this.getConstructor()} requires a Input Plugin`)}getScene(){return this.getInput().flatMap((t=>t.getScene()))}getRequiredScene(){return this.getScene().expect(`${this.getConstructor()} requires a Scene`)}queueEvent(t){return this.getInput().map((e=>e.queueEvent(t)))}onAdd(){return this}onRemove(){return this}onUpdate(t){return this}onAfterUpdate(t){return this}}class Lt{constructor(t,e,s){this.gravity=3,this.sensitivity=3,this.dead=.001,this.value=0,this.name=t,this.negButton=e,this.posButton=s}getName(){return this.name}getNegButton(){return this.negButton}setNegButton(t){return this.negButton=t,this}getPosButton(){return this.posButton}setPosButton(t){return this.posButton=t,this}getGravity(){return this.gravity}setGravity(t){return this.gravity=t,this}getSensitivity(){return this.sensitivity}setSensitivity(t){return this.sensitivity=t,this}getDead(){return this.dead}setDead(t){return this.dead=t,this}getValue(){return this.value}UNSAFE_setValue(t){return this.value=t,this}UNSAFE_update(t,e,s,i){const r=t.getDelta();s&&(e-=this.getSensitivity()*r),i&&(e+=this.getSensitivity()*r),i||s||0===e||(e-=(e>=0?1:-1)*this.getGravity()*r),e=e>=1?1:e<=-1?-1:e,Math.abs(e)<=this.getDead()&&(e=0),this.value=e}toJSON(){return{name:this.name,negButton:this.negButton,posButton:this.posButton,gravity:this.gravity,sensitivity:this.sensitivity,dead:this.dead,value:this.value}}fromJSON(t){return this.name=t.name,this.negButton=t.negButton,this.posButton=t.posButton,this.gravity=t.gravity,this.sensitivity=t.sensitivity,this.dead=t.dead,this.value=t.value,this}}class Ut{constructor(t){this.value=0,this.frameDown=0,this.frameUp=0,this.name=t}getName(){return this.name}getFrameDown(){return this.frameDown}getFrameUp(){return this.frameUp}getValue(){return this.value}UNSAFE_setValue(t){return this.value=t,this}UNSAFE_up(t){return 1===this.value&&(this.frameUp=t),this.value=0,this}UNSAFE_down(t){return 0===this.value&&(this.frameDown=t),this.value=1,this}toJSON(){return{name:this.name,value:this.value,frameDown:this.frameDown,frameUp:this.frameUp}}fromJSON(t){return this.name=t.name,this.value=t.value,this.frameDown=t.frameDown,this.frameUp=t.frameUp,this}}class bt extends f{constructor(){super(...arguments),this.input=a()}getConstructor(){return Object.getPrototypeOf(this).constructor}UNSAFE_setInput(t){return this.input.replace(t),this}UNSAFE_removeInput(){return this.input.clear(),this}getInput(){return this.input}getRequiredInput(){return this.getInput().expect(`${this.getConstructor()} requires a Input Plugin`)}getScene(){return this.getInput().flatMap((t=>t.getScene()))}getRequiredScene(){return this.getScene().expect(`${this.getConstructor()} requires a Scene`)}onAdd(){return this}onRemove(){return this}onUpdate(t){return this}onAfterUpdate(t){return this}}class qt extends bt{onEvent(t,e){const s=this.getRequiredInput();switch(e.type){case"mousemove":s.getOrCreateButton("mouse-x").UNSAFE_setValue(e.x),s.getOrCreateButton("mouse-y").UNSAFE_setValue(e.y);break;case"mousedown":s.getOrCreateButton("mouse-x").UNSAFE_setValue(e.x),s.getOrCreateButton("mouse-y").UNSAFE_setValue(e.y),s.getOrCreateButton(`mouse-${e.button}`).UNSAFE_down(t.getFrame());break;case"mouseup":case"mouseleave":s.getOrCreateButton("mouse-x").UNSAFE_setValue(e.x),s.getOrCreateButton("mouse-y").UNSAFE_setValue(e.y),s.getOrCreateButton(`mouse-${e.button}`).UNSAFE_up(t.getFrame());break;case"wheel":s.getOrCreateButton("mouse-wheel").UNSAFE_setValue(e.wheel)}return this}onAfterUpdate(){return this.getRequiredInput().getOrCreateButton("mouse-wheel").UNSAFE_setValue(0),this}}class It extends bt{onEvent(t,e){const s=this.getRequiredInput();switch(e.type){case"keydown":s.getOrCreateButton(e.code).UNSAFE_down(t.getFrame());break;case"keyup":s.getOrCreateButton(e.code).UNSAFE_up(t.getFrame())}return this}}class _t extends bt{onEvent(t,e){const s=this.getRequiredInput();switch(e.type){case"touchstart":s.getOrCreateButton(`touch-${e.id}-x`).UNSAFE_setValue(e.x),s.getOrCreateButton(`touch-${e.id}-y`).UNSAFE_setValue(e.y),s.getOrCreateButton(`touch-${e.id}`).UNSAFE_down(t.getFrame());break;case"touchmove":s.getOrCreateButton(`touch-${e.id}-x`).UNSAFE_setValue(e.x),s.getOrCreateButton(`touch-${e.id}-y`).UNSAFE_setValue(e.y);break;case"touchend":s.getOrCreateButton(`touch-${e.id}`).UNSAFE_up(t.getFrame())}return this}}class Ft extends bt{onEvent(t,e){const s=this.getRequiredInput();switch(e.type){case"resize":s.getOrCreateButton("screen-width").UNSAFE_setValue(e.width),s.getOrCreateButton("screen-height").UNSAFE_setValue(e.height)}return this}}class jt extends yt{constructor(){super(),this.events=[],this.inputHandlers=[],this.inputHandlerMap=new Map,this.eventListeners=[],this.eventListenerMap=new Map,this.buttons={},this.axes={},this.addInputHandler(new qt,new It,new _t,new Ft),this.addAxis(new Lt("horizontal-keys","ArrowLeft","ArrowRight"),new Lt("vertical-keys","ArrowDown","ArrowUp"))}queueEvent(t){return this.emit("event",t),this.events.push(t),this}addAxes(t){for(const e of t)this._addAxis(e);return this}addAxis(...t){return this.addAxes(t)}getAxis(t){return o.from(this.axes[t])}getAxisValue(t){return this.getAxis(t).map((t=>t.getValue())).unwrapOr(0)}getRequiredAxis(t){return this.getAxis(t).expect(`Failed to get Required Axis ${t}`)}getInputHandler(t){return o.from(this.inputHandlerMap.get(t))}getRequiredInputHandler(t){return this.getInputHandler(t).expect(`Failed to get Required InputHandler ${t}`)}getEventListener(t){return o.from(this.eventListenerMap.get(t))}getRequiredEventListener(t){return this.getEventListener(t).expect(`Failed to get Required EventListener ${t}`)}removeAxes(t){for(const e of t)this._removeAxis(e);return this}removeAxis(...t){return this.removeAxes(t)}addInputHandlers(t){for(const e of t)this._addInputHandler(e);return this}addInputHandler(...t){return this.addInputHandlers(t)}removeInputHandlers(t){for(const e of t)this._removeInputHandler(e);return this}removeInputHandler(...t){return this.removeInputHandlers(t)}addEventListeners(t){for(const e of t)this._addEventListener(e);return this}addEventListener(...t){return this.addEventListeners(t)}removeEventListeners(t){for(const e of t)this._removeEventListener(e);return this}removeEventListener(...t){return this.removeEventListeners(t)}getOrCreateButton(t){const e=this.buttons[t];if(e)return e;{const e=new Ut(t);return this.buttons[t]=e,e}}getButton(t){return o.from(this.buttons[t])}getButtonValue(t){return this.getButton(t).map((t=>t.getValue())).unwrapOr(0)}isDownCurrentFrame(t){return this.getButton(t).map((t=>t.getFrameDown()===this.getRequiredPlugin(Mt).getFrame())).unwrapOr(!1)}isDown(t){return!this.isUp(t)}isUpCurrentFrame(t){return this.getButton(t).map((t=>t.getFrameUp()===this.getRequiredPlugin(Mt).getFrame())).unwrapOr(!1)}isUp(t){return 0==this.getButtonValue(t)}onUpdate(){const t=this.getRequiredPlugin(Mt);for(const e of this.eventListeners)e.onUpdate(t);for(const e of this.inputHandlers){for(const s of this.events)e.onEvent(t,s);e.onUpdate(t)}for(const t of this.events)this.emit(t.type,t);for(const t of this.eventListeners)for(let e=0;e<this.events.length;e++){const s=this.events[e];t.dequeueEvent(s)&&(this.events.splice(e,1),e--)}return this.events.length=0,this.updateAxes(t),this}onAfterUpdate(){const t=this.getRequiredPlugin(Mt);for(const e of this.eventListeners)e.onAfterUpdate(t);for(const e of this.inputHandlers)e.onAfterUpdate(t);return this}_addAxis(t){return this.axes[t.getName()]||(this.axes[t.getName()]=t),this}_removeAxis(t){return this.axes[t.getName()]&&delete this.axes[t.getName()],this}updateAxes(t){for(const e of Object.values(this.axes))this.updateAxis(e,t)}updateAxis(t,e){const s=this.getButtonValue(t.getPosButton()),i=this.getButtonValue(t.getNegButton());t.UNSAFE_update(e,t.getValue(),0!==i,0!==s)}_addInputHandler(t){const e=t.getConstructor();return this.inputHandlerMap.has(e)||(this.inputHandlers.push(t),this.inputHandlerMap.set(e,t),t.UNSAFE_setInput(this),t.onAdd(),this.emit("add-input_handler",t)),this}_removeInputHandler(t){return this.getInputHandler(t).ifSome((e=>{this.emit("remove-input_handler",e),e.onRemove(),this.inputHandlers.splice(this.inputHandlers.indexOf(e),1),this.inputHandlerMap.delete(t),e.UNSAFE_removeInput()})),this}_addEventListener(t){const e=t.getConstructor();return this.eventListenerMap.has(e)||(this.eventListeners.push(t),this.eventListenerMap.set(e,t),t.UNSAFE_setInput(this),t.onAdd(),this.emit("add-event_listener",t)),this}_removeEventListener(t){return this.getEventListener(t).ifSome((e=>{this.emit("remove-event_listener",e),e.onRemove(),this.eventListeners.splice(this.eventListeners.indexOf(e),1),this.eventListenerMap.delete(t),e.UNSAFE_removeInput()})),this}toJSON(){return Object.assign(Object.assign({},super.toJSON()),{buttons:Object.values(this.buttons).map((t=>t.toJSON())),axes:Object.values(this.axes).map((t=>t.toJSON())),inputHandlers:this.inputHandlers.map((t=>t.toJSON()))})}fromJSON(t){if(super.fromJSON(t),d(t.buttons))for(const e of t.buttons){const t=e,s=new Ut(t.name).fromJSON(t);this.buttons[s.getName()]=s}return d(t.axes)&&this.addAxes(t.axes.map((t=>{const e=t;return new Lt(e.name,e.negButton,e.posButton).fromJSON(e)}))),d(t.inputHandlers)&&this.addInputHandlers(t.inputHandlers.map((t=>bt.newFromJSON(t)))),this}}class Jt{constructor(t){this.type=t}static init(t,e){return t.type=e,t}}class Ht extends Jt{constructor(){super(...arguments),this.code=""}}class Tt extends Jt{constructor(){super(...arguments),this.button=0,this.x=0,this.y=0}}class Bt extends Jt{constructor(){super(...arguments),this.wheel=0}}class zt extends Jt{constructor(){super(...arguments),this.width=0,this.height=0}}class kt extends Jt{constructor(){super(...arguments),this.id=0,this.x=0,this.y=0}}class Dt extends Ct{constructor(t){super(),this.onResizeEventListener=()=>{this.runOnUpdate(this.onResize)},this.canvas=t}getCanvas(){return this.canvas}onAdd(){return this.getRequiredPlugin(jt).on("resize",this.onResizeEventListener),this}onRemove(){return this.getRequiredPlugin(jt).off("resize",this.onResizeEventListener),this}onResize(){const t=this.getRequiredPlugin(jt);this.canvas.set(t.getButtonValue("screen-width"),t.getButtonValue("screen-height"))}}Dt.toFromJSONEnabled=!1,Dt.requiredPlugins=[jt];const Wt="undefined"!=typeof window?window:{},$t="undefined"!=typeof performance?performance:Date;let Vt=Wt.requestAnimationFrame&&Wt.requestAnimationFrame.bind(Wt),Yt=Wt.cancelAnimationFrame&&Wt.cancelAnimationFrame.bind(Wt);if(!Vt||!Yt){let t=0;Vt=e=>{const s=$t.now(),i=Math.max(t+1e3/60,s);return setTimeout((()=>{e(t=i)}),i-s)},Yt=t=>clearTimeout(t)}class Xt extends yt{constructor(){super(...arguments),this.id=null,this.running=!1,this.start=()=>{this.running||(this.running=!0,this.request())},this.run=t=>(this.id=null,this.getRequiredScene().update(),this.running=!1,this)}onInit(){return this.getRequiredPlugin(jt).on("event",this.start),this.start(),this}onRemove(){return this.getRequiredPlugin(jt).off("event",this.start),this}stop(){return this.running=!1,null!==this.id&&(Yt(this.id),this.id=null),this}isStopped(){return!1===this.running}request(){return this.id=Vt(this.run),this}}Xt.requiredPlugins=[jt];class Zt extends yt{constructor(){super(...arguments),this.id=null,this.running=!1,this.resolves=[],this.run=t=>{if(this.getRequiredScene().update(),this.running)this.request();else if(this.resolves.length){const t=this.resolves;this.resolves=[];for(const e of t)e()}return this}}promise(){return this.running?new Promise((t=>this.resolves.push(t))):Promise.resolve()}start(){this.running||(this.running=!0,this.request())}stop(){return this.running=!1,null!==this.id&&(Yt(this.id),this.id=null),this}isStopped(){return!1===this.running}request(){return this.id=Vt(this.run),this}onInit(){return this.start(),this}}class Qt extends S{onInit(){return this}onAfterUpdate(){return this}}const Kt=t.create(),Gt=t.create(),te=t.create(),ee=t.fromValues(0,0),se=t.fromValues(1e-6,1e-6);class ie extends y{constructor(){super(...arguments),this.enabled=!0,this.panSpeed=1,this.zoomSpeed=1,this.dragging=!1,this.lastMouse=t.create(),this.offset=t.create()}getEnabled(){return this.enabled}setEnabled(t=!0){return this.enabled=t,this}getPanSpeed(){return this.panSpeed}setPanSpeed(t){return this.panSpeed=t,this}getZoomSpeed(){return this.zoomSpeed}setZoomSpeed(t){return this.zoomSpeed=t,this}onUpdate(){const e=this.getRequiredPlugin(jt),s=E.getRequiredTransform(this.getRequiredEntity()),i=s.getLocalScale2(Gt),r=this.getRequiredComponent(ft).toRelative(Kt,t.set(Kt,-e.getButtonValue("mouse-x"),-e.getButtonValue("mouse-y")));this.dragging&&(t.sub(this.offset,r,this.lastMouse),t.scale(this.offset,this.offset,this.panSpeed),t.mul(this.offset,this.offset,i),t.rotate(this.offset,this.offset,ee,s.getRotationZ()),this.enabled&&s.translate2(this.offset)),e.isDown("mouse-0")?this.dragging=!0:this.dragging=!1;const n=e.getButtonValue("mouse-wheel"),o=t.set(te,this.zoomSpeed,this.zoomSpeed);return 0!==n&&this.enabled&&(n>0?t.add(i,i,o):n<0&&(t.sub(i,i,o),t.max(i,se,i)),s.setLocalScale2(i)),t.copy(this.lastMouse,r),this}toJSON(){return Object.assign(Object.assign({},super.toJSON()),{enabled:this.enabled,zoomSpeed:this.zoomSpeed,panSpeed:this.panSpeed})}fromJSON(t){return this.setEnabled(t.enabled),this.setZoomSpeed(t.zoomSpeed),this.setPanSpeed(t.panSpeed),this}}ie.Manager=Qt,ie.requiredComponents=[[ot,dt]],ie.requiredPlugins=[jt];class re extends N{constructor(){super(...arguments),this.active=a()}setActive(t){if(!t.getManager().map((t=>t===this)).unwrapOr(!1))throw new Error("Camera3DManager.setActive(camera: Camera3D): cannot set active if camera is not in manager");return this.active.replace(t),this}getActive(){return this.active}getRequiredActive(){return this.getActive().expect("Expected an Active Camera")}addComponent(t){return super.addComponent(t),this.active.isNone()&&this.active.replace(t),this}removeComponent(t){return super.removeComponent(t),this.active.ifSome((e=>{e===t&&this.active.clear()})),this}}const ne=s.create(),oe=t.create();class ae extends y{constructor(){super(...arguments),this.width=1,this.height=1,this.aspect=1,this.orthographic=!1,this.size=1,this.minSize=Number.EPSILON,this.maxSize=1/0,this.fov=16,this.near=1e-6,this.far=1024,this.projection=s.identity(s.create()),this.view=s.identity(s.create()),this.needsUpdate=!0,this.background=n.create()}getBackground(){return this.background}setBackground(t){return n.copy(this.background,t),this}set(t,e){return t!==this.width||e!==this.height?(this.width=t,this.height=e,this.aspect=t/e,this.setNeedsUpdate()):this}getWidth(){return this.width}setWidth(t){return this.set(t,this.height)}getHeight(){return this.height}setHeight(t){return this.set(this.width,t)}getAspect(){return this.aspect}getSize(){return this.size}setSize(t){return this.size=t<this.minSize?this.minSize:t>this.maxSize?this.maxSize:t,this.setNeedsUpdate()}getMinSize(){return this.minSize}setMinSize(t){return this.minSize=t,this.setNeedsUpdate()}getMaxSize(){return this.minSize}setMaxSize(t){return this.maxSize=t,this.setNeedsUpdate()}getFov(){return this.fov}setFov(t){return this.fov=t,this.setNeedsUpdate()}getNear(){return this.near}setNear(t){return this.near=t,this.setNeedsUpdate()}getFar(){return this.far}setFar(t){return this.far=t,this.setNeedsUpdate()}getView(){return this.getEntity().ifSome((t=>E.getTransform(t).ifSome((t=>{s.invert(this.view,t.getMatrix4(ne))})))),this.view}getProjection(){return this.updateProjectionIfNeeded().projection}setNeedsUpdate(t=!0){return this.needsUpdate=t,this}updateProjectionIfNeeded(){return this.needsUpdate?this.updateProjection():this}isActive(){return this.getRequiredManager().getActive().map((t=>t===this)).unwrapOr(!1)}setActive(){return this.getRequiredManager().setActive(this),this}updateProjection(){if(this.orthographic){const t=this.size*this.aspect,e=-t,i=this.size,r=-i;s.ortho(this.projection,e,t,r,i,this.near,this.far)}else s.perspective(this.projection,this.fov,this.aspect,this.near,this.far);return this.needsUpdate=!1,this}toRelative(t,s){return this.toWorld(t,s),e.transformMat4(t,t,this.getView()),t}toWorld(t,i){const r=ne;return t[0]=i[0]/this.width*2-1,t[1]=i[1]/this.height*-2+1,t[2]=this.near,s.mul(r,this.projection,this.getView()),s.invert(r,r),e.transformMat4(t,t,r),t}toScreen(e,i){const r=s.mul(ne,this.getProjection(),this.getView());return oe[0]=i[0],oe[1]=i[1],t.transformMat4(e,oe,r),e[0]=.5*(e[0]+1)*this.width,e[1]=.5*(1-e[1])*this.height,e}toJSON(){return Object.assign(Object.assign({},super.toJSON()),{width:this.width,height:this.height,size:this.size,fov:this.fov,near:this.near,far:this.far,background:this.background})}fromJSON(t){return super.fromJSON(t).set(t.width,t.height).setSize(t.size).setFov(t.fov).setNear(t.near).setFar(t.far).setBackground(t.background)}}ae.Manager=re,ae.requiredComponents=[[ot,dt]];class he extends N{constructor(){super(...arguments),this.layers={},this.sortFunction=(t,e)=>t.getRequiredEntity().getDepth()-e.getRequiredEntity().getDepth()}isEmpty(){return 0===Object.values(this.layers).length}getComponents(){return[].concat(...Object.values(this.layers))}addComponent(t){return this.getOrCreateLayer(t.getLayer()).push(t),this}removeComponent(t){const e=t.getLayer(),s=this.layers[e];if(s){const i=s.indexOf(t);-1!==i&&(s.splice(i,1),0===s.length&&delete this.layers[e])}return this}sort(){for(const t of Object.values(this.layers))t.sort(this.sortFunction);return this}getOrCreateLayer(t){const e=this.layers[t];if(e)return e;{const e=[];return this.layers[t]=e,e}}}class ue extends y{constructor(){super(...arguments),this.layer=0,this.imageAsset=a(),this.clipX=0,this.clipY=0,this.clipWidth=1,this.clipHeight=1,this.width=1,this.height=1,this.onImageLoadHandler=()=>{this.imageAsset.ifSome((t=>{this.clipWidth=t.getWidth(),this.clipHeight=t.getHeight(),t.off("load",this.onImageLoadHandler)}))}}getClipX(){return this.clipX}setClipX(t){return this.clipX=t,this}getClipY(){return this.clipY}setClipY(t){return this.clipY=t,this}getClipWidth(){return this.clipWidth}setClipWidth(t){return this.clipWidth=t,this}getClipHeight(){return this.clipHeight}setClipHeight(t){return this.clipHeight=t,this}getSize(t){return t[0]=this.width,t[1]=this.height,t}getWidth(){return this.width}setWidth(t){return this.width=t,this}getHeight(){return this.height}setHeight(t){return this.height=t,this}getLayer(){return this.layer}setLayer(t){const e=this.getManager();return e.ifSome((t=>t.removeComponent(this))),this.layer=0|t,e.ifSome((t=>t.addComponent(this))),this}getImageAsset(){return this.imageAsset}setImageAsset(t){return this.imageAsset.replace(t),t.isLoaded()?this.onImageLoadHandler():t.on("load",this.onImageLoadHandler),this}toJSON(){return Object.assign(Object.assign({},super.toJSON()),{imageAssetUUID:this.imageAsset.map((t=>t.getUUID())).unwrapOr(null),layer:this.layer,clipX:this.clipX,clipY:this.clipY,clipWidth:this.clipWidth,clipHeight:this.clipHeight,width:this.width,height:this.height})}fromJSON(t){const e=()=>{this.setImageAsset(this.getRequiredPlugin(Nt).getAsset(t.imageAssetUUID).expect(`Sprite.fromJSON Failed to get Asset ${t.imageAssetUUID}`)),this.off("add-to-scene",e)};return this.on("add-to-scene",e),super.fromJSON(t).setLayer(t.layer).setClipX(t.clipX).setClipY(t.clipY).setClipWidth(t.clipWidth).setClipHeight(t.clipHeight).setWidth(t.width).setHeight(t.height)}}ue.requiredPlugins=[Nt],ue.Manager=he;class ce{constructor(){this.duration=1,this.x=0,this.y=0,this.width=1,this.height=1}getDuration(){return this.duration}setDuration(t){return this.duration=t,this}getX(){return this.x}setX(t){return this.x=t,this}getY(){return this.y}setY(t){return this.y=t,this}getWidth(){return this.width}setWidth(t){return this.width=t,this}getHeight(){return this.height}setHeight(t){return this.height=t,this}toJSON(){return{duration:this.duration,x:this.x,y:this.y,width:this.width,height:this.height}}fromJSON(t){return this.duration=t.duration,this.x=t.x,this.y=t.y,this.width=t.width,this.height=t.height,this}}class de extends x{constructor(){super(...arguments),this.currentTime=0,this.currentFrame=0,this.playBack=1,this.currentName=a(),this.spriteSheets={},this.get=t=>o.from(this.spriteSheets[t])}set(t,e){return this.spriteSheets[t]=e,this}getPlayBack(){return this.playBack}setPlayBack(t){return this.playBack=t,this}setCurrent(t){if(!this.spriteSheets.hasOwnProperty(t))throw new Error(`SpriteSheet setCurrent(name: string) no SpriteSheet found named ${t}`);return this.currentName.replace(t),this.currentFrame=0,this.currentTime=0,this}getCurrent(){return this.currentName.flatMap(this.get)}onUpdate(){return this.getCurrent().ifSome((t=>{const e=t[this.currentFrame];if(e){const s=this.getRequiredComponent(ue);s.setClipX(e.getX()),s.setClipY(e.getY()),s.setClipWidth(e.getWidth()),s.setClipHeight(e.getHeight()),this.currentTime>=e.getDuration()&&(this.currentTime=0,this.currentFrame+=1,this.currentFrame>=t.length&&(this.currentFrame=0)),this.currentTime+=this.getRequiredPlugin(Mt).getDelta()*this.playBack}})),this}}de.requiredComponents=[ue],de.requiredPlugins=[Mt];class le extends y{constructor(){super(...arguments),this.queue=[],this.swap=[]}runOnUpdate(...t){return this.queue.push(...t),this}onUpdate(){if(this.queue.length>0){const t=this.queue;this.queue=this.swap,this.swap=t;for(const e of t)e.call(this);this.swap.length=0}return this}}E.getTransform=function(t){const e=t.getComponent(ot).orElse((()=>t.getComponent(dt)));return e.isNone()?E.getParentTransform(t):e};class ge extends f{constructor(){super(...arguments),this.name=a(),this.depth=0,this.scene=a(),this.root=this,this.parent=a(),this.tags=new Set,this.children=[],this.components=new Map}getName(){return this.name}setName(t){return this.name.replace(t),this}removeName(){return this.name.take(),this}hasTags(t){return t.every((t=>this.tags.has(t)))}hasTag(...t){return this.hasTags(t)}getTags(){return this.tags}addTags(t){for(const e of t)this.tags.add(e);return this}removeTag(...t){return this.removeTags(t)}removeTags(t){for(const e of t)this.tags.delete(e);return this}clearTags(){return this.tags.clear(),this}addTag(...t){return this.addTags(t)}getDepth(){return this.depth}getRoot(){return this.root}isRoot(){return this.root===this}hasParent(){return this.parent.isSome()}getParent(){return this.parent}hasScene(){return this.scene.isSome()}getScene(){return this.scene}getRequiredScene(){return this.getScene().expect("Entity expected to have a Scene")}UNSAFE_setScene(t,e=!1){if(this.scene.replace(t),e)for(const s of this.children)s.UNSAFE_setScene(t,e);return this}UNSAFE_removeScene(){return this.scene.clear(),this}forEachChild(t,e=!0){for(const s of this.getChildren()){if(!1===t(s))break;e&&s.forEachChild(t,e)}return this}find(t,e=!0){for(const s of this.getChildren()){if(t(s))return u(s);if(e){const i=s.find(t,e);if(i.isSome())return i}}return a()}findWithName(t){return this.find((e=>e.name.map((e=>e===t)).unwrapOr(!1)))}findWithTag(...t){return this.find((e=>e.hasTags(t)))}findWithTags(t){return this.findWithTag(...t)}findWithComponent(t){return this.find((e=>e.getComponent(t).isSome()))}findAll(t,e=!0){const s=this.getChildren(),i=[];for(const r of s)t(r)?i.push(r):e&&i.push(...r.findAll(t,e));return i}findAllWithName(t,e=!0){return this.findAll((e=>e.name.map((e=>e===t)).unwrapOr(!1)),e)}findAllWithTag(...t){return this.findAll((e=>e.hasTags(t)))}findAllWithTags(t){return this.findAllWithTag(...t)}findAllWithComponent(t,e=!0){return this.findAll((e=>e.getComponent(t).isSome()),e)}findParent(t){return this.getParent().flatMap((e=>t(e)?u(e):e.findParent(t)))}getComponents(){return this.components}hasComponent(t){return this.getComponent(t).isSome()}getComponent(t){return o.from(this.components.get(t))}getRequiredComponent(t){return this.getComponent(t).expect((()=>`Entity expected to have a ${t} Component`))}getComponentInstanceOf(t){for(const e of this.components.values())if(e instanceof t)return u(e);return a()}getComponentsInstanceOf(t){return Array.from(this.components.values()).filter((e=>e instanceof t))}addComponents(t){for(const e of t)this._addComponent(e);return this}addComponent(...t){return this.addComponents(t)}removeComponents(t){for(const e of t)this._removeComponent(e);return this}removeComponent(...t){return this.removeComponents(t)}removeFromScene(){this.scene.ifSome((t=>{t.removeEntity(this)}))}detach(){this.parent.ifSome((t=>{t._removeChild(this),this.scene.ifSome((t=>t.addEntity(this)));for(const t of this.components.values())t.onDetach()}))}getChildren(){return this.children}addChildren(t){for(const e of t)this._addChild(e);return this}addChild(...t){return this.addChildren(t)}removeChildren(t){for(const e of t)this._removeChild(e);return this}removeChild(...t){return this.removeChildren(t)}validateRequirements(){const t=new Map,e=new Map;for(const[s,i]of this.components){const r=St(i.getRequiredComponents(),(t=>!this.hasComponent(t))),n=St(i.getRequiredPlugins(),(t=>!this.getRequiredScene().hasPlugin(t)));r.length>0&&t.set(s,r),r.length>0&&e.set(s,n)}if(t.size>0||e.size>0){const s=[...t.entries()].map((([t,e])=>e.map((e=>`Entity's ${xt(t)} requires ${xt(e)} Component`)).join("\n"))).join("\n"),i=[...e.entries()].map((([t,e])=>e.map((e=>`Entity's ${xt(t)} requires ${xt(e)} Plugin`)).join("\n"))).join("\n");throw new Error(s?`${s}\n${i}`:i)}}_addComponent(t){const e=t.getConstructor();return this.components.has(e)||(t.UNSAFE_setEntity(this),this.components.set(e,t),this.scene.ifSome((e=>e.UNSAFE_addComponent(t))),this.emit("add-component",t)),this}_removeComponent(t){return this.getComponent(t).ifSome((e=>{this.emit("remove-component",e),e.UNSAFE_removeEntity(),this.components.delete(t),this.scene.ifSome((t=>t.UNSAFE_removeComponent(e)))})),this}_addChild(t){return-1===this.children.indexOf(t)&&(t.isRoot()&&t.scene.ifSome((e=>e.removeEntity(t))),t.parent.ifSome((e=>e._removeChild(t))),this.children.push(t),t.parent.replace(this),t.root=this.root,t.setDepth(this.depth+1),this.scene.ifSome((e=>e.UNSAFE_addEntityNow(t,!0))),this.emit("add-child",t)),this}_removeChild(t){return this.scene.ifSome((e=>e.UNSAFE_removeEntityNow(t))),this.UNSAFE_removeChild(t),this}UNSAFE_removeChild(t){const e=this.children.indexOf(t);return-1!==e&&(this.emit("remove-child",t),this.children.splice(e,1),t.scene.clear(),t.parent.clear(),t.root=t,t.setDepth(0)),this}setDepth(t){this.depth=t;for(const e of this.children)e.setDepth(t+1);return this}toJSON(){return Object.assign(Object.assign({},super.toJSON()),{name:this.name.unwrapOr(null),tags:[...this.tags.values()],children:this.children.map((t=>t.toJSON())),components:[...this.components.values()].map((t=>t.toJSON()))})}fromJSON(t){return super.fromJSON(t),t.name&&this.name.replace(t.name),d(t.tags)&&this.addTags(t.tags),d(t.children)&&this.addChildren(t.children.map((t=>(new ge).fromJSON(t)))),d(t.components)&&this.addComponents(t.components.map((t=>x.newFromJSON(t)))),this}}class pe extends f{constructor(){super(...arguments),this.name=a(),this.entities=[],this.entitiesToAdd=[],this.entitiesToRemove=[],this.managers=[],this.managerMap=new Map,this.plugins=[],this.pluginsMap=new Map,this.isUpdating=!1,this.isInitted=!1,this.sortPluginsFunction=(t,e)=>t.getPluginPriority()-e.getPluginPriority()}init(){if(!this.isInitted){this.isInitted=!0,this.emit("init"),this.maintain();for(const t of this.plugins)t.onInit();for(const t of this.managers)t.onInit();this.isInitted=!0}return this}maintain(t=!0){t&&this.emit("maintain");for(const t of this.entitiesToRemove)this.removeEntityNow(t,!0);this.entitiesToRemove.length=0;for(const t of this.entitiesToAdd)this.addEntityNow(t,!0);return this.entitiesToAdd.length=0,this}update(){this.init(),this.isUpdating=!0,this.emit("update"),this.maintain();for(const t of this.plugins)t.onUpdate();for(const t of this.managers)t.onUpdate();for(const t of this.managers)t.onAfterUpdate();for(const t of this.plugins)t.onAfterUpdate();return this.isUpdating=!1,this}clear(){return this.emit("clear"),this.removeEntities(this.entities),this.removePlugin(...this.pluginsMap.keys()),this}getName(){return this.name}setName(t){return this.name.replace(t),this}removeName(){return this.name.take(),this}forEachEntity(t,e=!0){for(const s of this.entities){if(!1===t(s))break;e&&s.forEachChild(t,e)}return this}find(t,e=!0){for(const s of this.entities){if(t(s))return u(s);if(e){const i=s.find(t,e);if(i.isSome())return i}}return a()}findWithTag(...t){return this.find((e=>e.hasTags(t)),!0)}findWithTags(t){return this.findWithTag(...t)}findWithName(t){return this.find((e=>e.getName().map((e=>e===t)).unwrapOr(!1)),!0)}findAll(t,e=!0){const s=[];for(const i of this.entities)t(i)?s.push(i):e&&s.push(...i.findAll(t,e));return s}findAllWithTag(...t){return this.findAll((e=>e.hasTags(t)),!0)}findAllWithTags(t){return this.findAllWithTag(...t)}findAllWithName(t){return this.findAll((e=>e.getName().map((e=>e===t)).unwrapOr(!1)),!0)}getEntities(){return this.entities}getManagers(){return this.managers}getManager(t){return o.from(this.managerMap.get(t))}getRequiredManager(t){return this.getManager(t).expect((()=>`Scene required ${t} Manager`))}getPlugins(){return this.plugins}hasPlugin(t){return this.getPlugin(t).isSome()}getPlugin(t){return o.from(this.pluginsMap.get(t))}getRequiredPlugin(t){return this.getPlugin(t).expect((()=>`Scene required ${t} Plugin`))}addPlugins(t){for(const e of t)this._addPlugin(e);return this.sortPlugins()}addPlugin(...t){return this.addPlugins(t)}removePlugins(t){for(const e of t)this._removePlugin(e);return this}removePlugin(...t){return this.removePlugins(t)}addEntities(t){return this.entitiesToAdd.push(...t),this}addEntity(...t){return this.addEntities(t)}removeEntities(t){return this.entitiesToRemove.push(...t),this}removeEntity(...t){return this.removeEntities(t)}addEntityNow(t,e=!1){if(this.isUpdating&&!e)throw new Error("Scene.addEntityNow called while updating, use force to suppress this Error");return this.UNSAFE_addEntityNow(t,!1)}removeEntityNow(t,e=!1){if(this.isUpdating&&!e)throw new Error("Scene.removeEntityNow called while updating, use force to suppress this Error");return this.UNSAFE_removeEntityNow(t)}UNSAFE_addComponent(t){const e=t.getManagerConstructor(),s=this.getManager(e);let i;return s.isNone()?(i=new e,i.UNSAFE_setScene(this),this.managers.push(i),this.managerMap.set(e,i),this.sortManagers(),i.onAdd()):i=s.unwrap(),i.addComponent(t),t.UNSAFE_setManager(i),i.sort(),t.onAdd(),t.emit("add-to-scene"),this.emit("add-component",t),this}UNSAFE_removeComponent(t){const e=t.getManagerConstructor(),s=this.getManager(e);return this.emit("remove-component",t),t.emit("remove-from-scene"),s.ifSome((s=>{t.onRemove(),s.removeComponent(t),t.UNSAFE_removeManager(),s.isEmpty()&&(s.onRemove(),this.managers.splice(this.managers.indexOf(s),1),this.managerMap.delete(e))})),this}UNSAFE_addEntityNow(t,e){const s=t.getScene();if(s.isSome()){const e=s.unwrap();if(e===this)throw new Error("Scene trying to add an Entity that is already a member of the Scene");e.removeEntityNow(t,!0)}if(t.isRoot())this.entities.push(t);else if(!e)throw new Error("Scene trying to add an Entity that already has a parent");t.UNSAFE_setScene(this);for(const e of t.getComponents().values())this.UNSAFE_addComponent(e);for(const e of t.getChildren())this.UNSAFE_addEntityNow(e,!0);return this.emit("add-entity",t),this}UNSAFE_removeEntityNow(t){const e=t.getScene();if(e.isSome()){if(e.unwrap()!==this)throw new Error("Scene trying to remove an Entity that is not a member of the Scene")}for(const e of t.getComponents().values())this.UNSAFE_removeComponent(e);if(t.isRoot()){const e=this.entities.indexOf(t);-1!==e&&(this.entities.splice(e,1),t.UNSAFE_removeScene())}else t.getParent().ifSome((e=>e.UNSAFE_removeChild(t)));for(const e of t.getChildren().slice())this.removeEntityNow(e,!0);return this.emit("remove-entity",t),this}_addPlugin(t){const e=t.getConstructor();if(!this.hasPlugin(e)){const e=t.getConstructor();this.plugins.push(t),this.pluginsMap.set(e,t),t.UNSAFE_setScene(this),this.isInitted&&t.onInit(),t.onAdd(),this.emit("add-plugin",t)}return this}_removePlugin(t){return this.getPlugin(t).ifSome((e=>{this.emit("remove-plugin",e),e.onRemove(),e.UNSAFE_removeScene(),this.plugins.splice(this.plugins.indexOf(e),1),this.pluginsMap.delete(t)})),this}sortPlugins(){return this.plugins.sort(this.sortPluginsFunction),this}sortManagers(){return this.managers.sort(this.managerSortFunction),this}managerSortFunction(t,e){return t.getManagerPriority()-e.getManagerPriority()}toJSON(){return Object.assign(Object.assign({},super.toJSON()),{name:this.name.unwrapOr(null),plugins:this.plugins.filter((t=>t.getConstructor().isToFromJSONEnabled())).map((t=>t.toJSON())),entities:this.entities.map((t=>t.toJSON()))})}fromJSON(t){return super.fromJSON(t),t.name&&this.name.replace(t.name),d(t.plugins)&&this.addPlugins(t.plugins.map((t=>yt.newFromJSON(t)))),d(t.entities)&&this.addEntities(t.entities.map((t=>(new ge).fromJSON(t)))),this.maintain(!1)}}class me extends f{constructor(){super(...arguments),this.width=1,this.height=1}getWidth(){return this.width}getHeight(){return this.height}setWidth(t){return this.set(t,this.height)}setHeight(t){return this.set(this.width,t)}set(t,e){const s=this.width,i=this.height;return t===s&&e===i||(this.width=t,this.height=e,this.onResize(),this.emit("resize",t,e,s,i)),this}}class fe extends Et{getCtx(){return this.getRequiredRenderer().getCtx()}getCamera(){return this.getRequiredRenderer().getCamera()}getScale(){return this.getRequiredRenderer().getScale()}}fe.rendererHandlerPriority=0;const ve=i.create();class Se extends fe{onRender(){return this.getManager(P).ifSome((t=>{const e=this.getRequiredRenderer(),s=e.getScale();for(const i of t.getComponents())i.getRenderable()&&e.render((t=>{t.beginPath(),t.strokeStyle="#0c0",t.moveTo(0,0),t.lineTo(0,.5),t.stroke(),t.beginPath(),t.strokeStyle="#00c",t.moveTo(0,0),t.lineTo(.5,0),t.stroke(),t.beginPath(),t.arc(0,0,2*s,0,2*Math.PI),t.fill()}),i.getMatrix2d(ve))})),this}}const xe=i.create(),ye=O.create(),Ne=O.create(),Pe=t.create(),we=t.create();class Ae extends fe{onRender(){return this.getManager(he).ifSome((t=>{const e=this.getRequiredRenderer(),s=this.getCamera().getAABB2(ye),i=Ne,r=Pe,n=we;for(const o of t.getComponents()){const t=o.getImageAsset().flatMap((t=>t.getImage()));if(o.getRenderable()&&t.isSome()){const a=t.unwrap(),h=E.getRequiredTransform(o.getRequiredEntity());if(st(i,h.getPosition2(r),h.getRotationZ(),o.getSize(n)),O.notIntersects(s,i))continue;e.render((t=>{const e=o.getWidth(),s=o.getHeight(),i=.5*e,r=.5*s;t.scale(1,-1),t.drawImage(a,o.getClipX(),o.getClipY(),o.getClipWidth(),o.getClipHeight(),-i,-r,e,s)}),h.getMatrix2d(xe))}}})),this}}const Ee=i.create();class Oe extends Ot{constructor(t){super(),this.lineWidth=1,this.camera=a(),this.cameraView=i.create(),this.cameraProjection=i.create(),this.cameraViewProjection=i.create(),this.scale=1,this.enabled=!0,this.getActiveCamera=()=>this.getRequiredScene().getRequiredManager(lt).getRequiredActive(),this.element=t,this.ctx=t.getContext("2d")}getCameraView(){return this.cameraView}getCameraProjection(){return this.cameraProjection}getCameraViewProjection(){return this.cameraViewProjection}getElement(){return this.element}getCtx(){return this.ctx}getEnabled(){return this.enabled}setEnabled(t=!0){return this.enabled=t,this}getLineWidth(){return this.lineWidth}setLineWidth(t){return this.lineWidth=t,this}getCamera(){return this.camera.unwrapOrElse(this.getActiveCamera)}setCamera(t){return this.camera.replace(t),this}removeCamera(){return this.camera.clear(),this}getCanvasSize(){const t=this.element.width,e=this.element.height;return.5*(t>e?e:t)}getScale(){return this.scale}render(t,e){const s=Ee;return e?i.mul(s,this.cameraViewProjection,e):i.copy(s,this.cameraViewProjection),this.ctx.save(),this.ctx.transform(s[0],s[1],s[2],s[3],s[4],s[5]),t(this.ctx),this.ctx.restore(),this}onUpdate(){if(!this.enabled)return this;const t=this.getCamera(),e=this.element.width,s=this.element.height,r=.5*e,n=.5*s;return t.set(e,s),i.copy(this.cameraView,t.getView()),i.copy(this.cameraProjection,t.getProjection()),i.mul(this.cameraViewProjection,this.cameraProjection,this.cameraView),this.scale=1/this.getCanvasSize()*t.getZoom(),this.ctx.save(),this.ctx.save(),this.ctx.fillStyle=K(t.getBackground()),this.ctx.fillRect(0,0,e,s),this.ctx.restore(),this.ctx.lineWidth=this.getLineWidth()*this.getScale(),this.ctx.transform(r,0,0,-n,r,n),super.onUpdate(),this.ctx.restore(),this}toJSON(){return Object.assign(Object.assign({},super.toJSON()),{lineWidth:this.lineWidth,enabled:this.enabled})}fromJSON(t){return super.fromJSON(t),this.lineWidth=t.lineWidth,this.enabled=t.enabled,this}}Oe.toFromJSONEnabled=!1;class Me extends At{constructor(t){super(),this.image=a(),this.src=t}getImage(){return this.image}getWidth(){return this.image.map((t=>t.width)).unwrapOr(0)}getHeight(){return this.image.map((t=>t.height)).unwrapOr(0)}loadAsset(){return new Promise(((t,e)=>{const s=new Image;s.addEventListener("load",(()=>{this.image.replace(s),t()})),s.addEventListener("error",(t=>e(t))),s.src=this.src}))}unloadAsset(){return this.image.clear(),Promise.resolve()}toJSON(){return Object.assign(Object.assign({},super.toJSON()),{src:this.src})}fromJSON(t){return super.fromJSON(t),this.src=t.src,this}}class Ce extends Rt{constructor(t){super(),this.touchInputEventPool=new l(kt,kt.init),this.mouseInputEventPool=new l(Tt,Tt.init),this.mouseWheelInputEventPool=new l(Bt,Bt.init),this.keyboardInputEventPool=new l(Ht,Ht.init),this.resizeInputEventPool=new l(zt,zt.init),this.onResize=()=>{const t=this.resizeInputEventPool.create("resize");t.width=this.window.innerWidth,t.height=this.window.innerHeight,this.queueEvent(t)},this.onTouch=t=>{const e=t,s=this.element.getBoundingClientRect();for(let t=0,i=e.touches.length;t<i;t++){const i=e.touches[t],r=i.clientX-s.left,n=i.clientY-s.top,o=this.touchInputEventPool.create(e.type);o.id=i.identifier,o.x=r,o.y=n,this.queueEvent(o)}},this.onMouse=t=>{const e=t,s=this.element.getBoundingClientRect(),i=e.clientX-s.left,r=e.clientY-s.top,n=this.mouseInputEventPool.create(e.type);n.button=e.button,n.x=i,n.y=r,this.queueEvent(n)},this.onMouseWheel=t=>{const e=t,s=this.mouseWheelInputEventPool.create(e.type);s.wheel=e.deltaY,this.queueEvent(s)},this.onKeyboard=t=>{const e=t,s=this.keyboardInputEventPool.create(e.type);s.code=e.code,this.queueEvent(s)},this.element=t,this.window=t.ownerDocument.defaultView}onAdd(){return this.window.addEventListener("orientationchange",this.onResize),this.window.addEventListener("resize",this.onResize),this.element.addEventListener("touchstart",this.onTouch),this.element.addEventListener("touchmove",this.onTouch),this.element.addEventListener("touchend",this.onTouch),this.element.addEventListener("touchcancel",this.onTouch),this.element.addEventListener("mousemove",this.onMouse),this.element.addEventListener("mousedown",this.onMouse),this.element.addEventListener("mouseup",this.onMouse),this.element.addEventListener("wheel",this.onMouseWheel),this.element.addEventListener("mouseleave",this.onMouse),this.element.addEventListener("keydown",this.onKeyboard),this.element.addEventListener("keyup",this.onKeyboard),this.onResize(),this}onRemove(){return this.window.removeEventListener("orientationchange",this.onResize),this.window.removeEventListener("resize",this.onResize),this.element.removeEventListener("touchstart",this.onTouch),this.element.removeEventListener("touchmove",this.onTouch),this.element.removeEventListener("touchend",this.onTouch),this.element.removeEventListener("touchcancel",this.onTouch),this.element.removeEventListener("mousemove",this.onMouse),this.element.removeEventListener("mousedown",this.onMouse),this.element.removeEventListener("mouseup",this.onMouse),this.element.removeEventListener("wheel",this.onMouseWheel),this.element.removeEventListener("mouseleave",this.onMouse),this.element.removeEventListener("keydown",this.onKeyboard),this.element.removeEventListener("keyup",this.onKeyboard),this}dequeueEvent(t){return t instanceof Tt?(this.mouseInputEventPool.release(t),!0):t instanceof Ht?(this.keyboardInputEventPool.release(t),!0):t instanceof Bt?(this.mouseWheelInputEventPool.release(t),!0):t instanceof kt&&(this.touchInputEventPool.release(t),!0)}}Ce.toFromJSONEnabled=!1;class Re extends me{constructor(t){super(),this.canvas=t||document.createElement("canvas"),this.set(this.canvas.width,this.canvas.height)}getElement(){return this.canvas}onResize(){return this.canvas.width=this.getWidth(),this.canvas.height=this.getHeight(),this.canvas.style.width=`${this.getWidth()}px`,this.canvas.style.height=`${this.getHeight()}px`,this}getImageURI(){return this.canvas.toDataURL("image/png").replace("image/png","image/octet-stream")}getStream(t=60){return this.canvas.captureStream(t)}}export{vt as Asset,Nt as Assets,ft as Camera2D,ie as Camera2DControl,Qt as Camera2DControlManager,lt as Camera2DManager,ae as Camera3D,re as Camera3DManager,me as Canvas,x as Component,Oe as CtxRenderer,fe as CtxRendererHandler,M as DEG_TO_RAD,N as DefaultDescriptorManager,S as DefaultManager,U as EPSILON,ge as Entity,Rt as EventListener,Xt as EventLoop,Dt as FullScreenCanvas,R as HALF_PI,At as ImageAsset,jt as Input,Lt as InputAxis,Ut as InputButton,Jt as InputEvent,bt as InputHandler,Pt as JSONAsset,p as JSONClassRegistry,Ht as KeyboardInputEvent,It as KeyboardInputHandler,Zt as Loop,v as Manager,Tt as MouseInputEvent,qt as MouseInputHandler,Bt as MouseWheelInputEvent,yt as Plugin,C as RAD_TO_DEG,wt as RawJSONAsset,y as RenderableComponent,Ot as Renderer,Et as RendererHandler,zt as ResizeInputEvent,Ft as ResizeInputHandler,le as RunOnUpdateComponent,Ct as RunOnUpdatePlugin,pe as Scene,ue as Sprite,ce as SpriteClip,Ae as SpriteCtxRendererHandler,he as SpriteManager,de as SpriteSheet,L as TAU,Mt as Time,f as ToFromJSONEventEmitter,kt as TouchInputEvent,_t as TouchInputHandler,ot as Transform2D,dt as Transform3D,E as TransformComponent,P as TransformComponentManager,Se as TransformCtxRendererHandler,Re as WebCanvas,Ce as WebEventListener,Me as WebImageAsset,D as angleVec2,Yt as cancelAnimationFrame,k as clamp,b as composeMat2d,_ as decomposeMat2d,Y as degToRad,X as equals,St as filterRequirements,st as getAABB2FromRect,B as getAngleBetweenPoints,J as getAngleFromPoint,j as getPointFromAngle,F as getRotationFromMat2d,T as getTangentAngle,m as globalJSONClassRegistry,$ as projectPointOnAxis,V as radToDeg,Vt as requestAnimationFrame,xt as requirementToString,z as sign,Z as toHex,Q as toRgb,K as toRgba,W as vec2FromAngle};
//# sourceMappingURL=index.js.map
