import{vec2 as t,vec3 as e,mat4 as s,mat2d as i,quat as r,vec4 as n}from"https://unpkg.com/gl-matrix@3/esm/index.js";import{v4 as o}from"https://unpkg.com/uuid@8/dist/esm-browser/index.js";import{isJSONArray as a}from"https://unpkg.com/@aicacia/json@0/browser/index.js";import{Pool as h}from"https://unpkg.com/@aicacia/pool@0/browser/index.js";var u={exports:{}};!function(t){var e=Object.prototype.hasOwnProperty,s="~";function i(){}function r(t,e,s){this.fn=t,this.context=e,this.once=s||!1}function n(t,e,i,n,o){if("function"!=typeof i)throw new TypeError("The listener must be a function");var a=new r(i,n||t,o),h=s?s+e:e;return t._events[h]?t._events[h].fn?t._events[h]=[t._events[h],a]:t._events[h].push(a):(t._events[h]=a,t._eventsCount++),t}function o(t,e){0==--t._eventsCount?t._events=new i:delete t._events[e]}function a(){this._events=new i,this._eventsCount=0}Object.create&&(i.prototype=Object.create(null),(new i).__proto__||(s=!1)),a.prototype.eventNames=function(){var t,i,r=[];if(0===this._eventsCount)return r;for(i in t=this._events)e.call(t,i)&&r.push(s?i.slice(1):i);return Object.getOwnPropertySymbols?r.concat(Object.getOwnPropertySymbols(t)):r},a.prototype.listeners=function(t){var e=s?s+t:t,i=this._events[e];if(!i)return[];if(i.fn)return[i.fn];for(var r=0,n=i.length,o=new Array(n);r<n;r++)o[r]=i[r].fn;return o},a.prototype.listenerCount=function(t){var e=s?s+t:t,i=this._events[e];return i?i.fn?1:i.length:0},a.prototype.emit=function(t,e,i,r,n,o){var a=s?s+t:t;if(!this._events[a])return!1;var h,u,c=this._events[a],l=arguments.length;if(c.fn){switch(c.once&&this.removeListener(t,c.fn,void 0,!0),l){case 1:return c.fn.call(c.context),!0;case 2:return c.fn.call(c.context,e),!0;case 3:return c.fn.call(c.context,e,i),!0;case 4:return c.fn.call(c.context,e,i,r),!0;case 5:return c.fn.call(c.context,e,i,r,n),!0;case 6:return c.fn.call(c.context,e,i,r,n,o),!0}for(u=1,h=new Array(l-1);u<l;u++)h[u-1]=arguments[u];c.fn.apply(c.context,h)}else{var d,g=c.length;for(u=0;u<g;u++)switch(c[u].once&&this.removeListener(t,c[u].fn,void 0,!0),l){case 1:c[u].fn.call(c[u].context);break;case 2:c[u].fn.call(c[u].context,e);break;case 3:c[u].fn.call(c[u].context,e,i);break;case 4:c[u].fn.call(c[u].context,e,i,r);break;default:if(!h)for(d=1,h=new Array(l-1);d<l;d++)h[d-1]=arguments[d];c[u].fn.apply(c[u].context,h)}}return!0},a.prototype.on=function(t,e,s){return n(this,t,e,s,!1)},a.prototype.once=function(t,e,s){return n(this,t,e,s,!0)},a.prototype.removeListener=function(t,e,i,r){var n=s?s+t:t;if(!this._events[n])return this;if(!e)return o(this,n),this;var a=this._events[n];if(a.fn)a.fn!==e||r&&!a.once||i&&a.context!==i||o(this,n);else{for(var h=0,u=[],c=a.length;h<c;h++)(a[h].fn!==e||r&&!a[h].once||i&&a[h].context!==i)&&u.push(a[h]);u.length?this._events[n]=1===u.length?u[0]:u:o(this,n)}return this},a.prototype.removeAllListeners=function(t){var e;return t?(e=s?s+t:t,this._events[e]&&o(this,e)):(this._events=new i,this._eventsCount=0),this},a.prototype.off=a.prototype.removeListener,a.prototype.addListener=a.prototype.on,a.prefixed=s,a.EventEmitter=a,t.exports=a}(u);class c{constructor(){this.constructorToTypeId=new Map,this.typeIdToConstructor=new Map}getByConstructor(t){const e=this.constructorToTypeId.get(t);if(e){const s=this.typeIdToConstructor.get(e);if(t===s)return e;throw new Error(`${t} and ${s} are using the same typeId ${e}`)}{const e=t.getTypeId();return this.constructorToTypeId.set(t,e),this.typeIdToConstructor.set(e,t),e}}getById(t){return this.typeIdToConstructor.get(t)||null}}const l=new c;class d extends u.exports.EventEmitter{static toString(){return this.getTypeId()}static getTypeId(){return this.typeId||this.name}static isToFromJSONEnabled(){return!!this.toFromJSONEnabled}static getConstructorFromJSON(t){const e=l.getById(t.typeId);if(!e)throw new Error(`Failed to get class ${t.typeId} from globalJSONClassRegistry make sure the Component was added`);return e}static newFromJSON(t){return(new(this.getConstructorFromJSON(t))).fromJSON(t)}getConstructor(){return Object.getPrototypeOf(this).constructor}toJSON(){return{typeId:l.getByConstructor(this.getConstructor())}}fromJSON(t){return this}}d.toFromJSONEnabled=!0;class g extends d{constructor(){super(...arguments),this.scene=null}static getManagerPriority(){return this.managerPriority}UNSAFE_setScene(t){return this.scene=t,this}UNSAFE_removeScene(){return this.scene=null,this}getScene(){return this.scene}getConstructor(){return Object.getPrototypeOf(this).constructor}getManagerPriority(){return Object.getPrototypeOf(this).constructor.getManagerPriority()}getPlugin(t){const e=this.getScene();return e?e.getPlugin(t):null}getRequiredPlugin(t){const e=this.getPlugin(t);if(!e)throw new Error(`${this.getConstructor()} required ${t} Plugin`);return e}getManager(t){const e=this.getScene();return e?e.getManager(t):null}getRequiredManager(t){const e=this.getManager(t);if(!e)throw new Error(`${this.getConstructor()} required ${t} Manager`);return e}onAdd(){return this}onRemove(){return this}}g.managerPriority=0;class p extends g{constructor(){super(...arguments),this.components=[],this.sortFunction=(t,e)=>t.getRequiredEntity().getDepth()-e.getRequiredEntity().getDepth()}getComponents(){return this.components}addComponent(t){return this.components.push(t),this}removeComponent(t){const e=this.components.indexOf(t);return-1!==e&&this.components.splice(e,1),this}isEmpty(){return 0===this.components.length}sort(){return this.components.sort(this.sortFunction),this}onInit(){for(const t of this.components)t.onInit();return this}onUpdate(){for(const t of this.components)t.onUpdate();return this}onAfterUpdate(){for(const t of this.components)t.onAfterUpdate();return this}}class m extends d{constructor(){super(...arguments),this.entity=null,this.manager=null}static getManagerConstructor(){if(!this.Manager)throw new Error(this+" invalid Manager `"+this.Manager+"` "+this);return this.Manager}static getRequiredComponents(){return this.requiredComponents}static getRequiredPlugins(){return this.requiredPlugins}getManagerConstructor(){return Object.getPrototypeOf(this).constructor.getManagerConstructor()}getRequiredComponents(){return Object.getPrototypeOf(this).constructor.requiredComponents}getRequiredPlugins(){return Object.getPrototypeOf(this).constructor.requiredPlugins}getComponent(t){return this.entity?this.entity.getComponent(t):null}getRequiredComponent(t){const e=this.getComponent(t);if(!e)throw new Error(`${this.getConstructor()} Component requires ${t} Component`);return e}getPlugin(t){const e=this.getScene();return e?e.getPlugin(t):null}getRequiredPlugin(t){const e=this.getPlugin(t);if(!e)throw new Error(`${this.getConstructor()} Component requires ${t} Plugin`);return e}UNSAFE_setEntity(t){return this.entity=t,this}UNSAFE_removeEntity(){return this.entity=null,this}getEntity(){return this.entity}getRequiredEntity(){const t=this.getEntity();if(!t)throw new Error(`${this.getConstructor()} Component requires an Entity`);return t}getScene(){const t=this.entity;return t?t.getScene():null}getRequiredScene(){const t=this.getScene();if(!t)throw new Error(`${this.getConstructor()} Component requires a Scene`);return t}UNSAFE_setManager(t){return this.manager=t,this}UNSAFE_removeManager(){return this.manager=null,this}getManager(){return this.manager}getRequiredManager(){const t=this.getManager();if(!t)throw new Error(`${this.getConstructor()} Component is not part of a Manager ${Object.getPrototypeOf(this).getManagerConstructor()} Manager`);return t}getSceneManager(t){const e=this.getScene();return e?e.getManager(t):null}getRequiredSceneManager(t){const e=this.getSceneManager(t);if(!e)throw new Error(`${this.getConstructor()} Component requires ${Object.getPrototypeOf(this).getManagerConstructor()} Manager`);return e}onInit(){return this}onDetach(){return this}onAdd(){return this}onRemove(){return this}onUpdate(){return this}onAfterUpdate(){return this}}m.Manager=p,m.requiredComponents=[],m.requiredPlugins=[];class f extends m{constructor(){super(...arguments),this.renderable=!0}getRenderable(){return this.renderable}setRenderable(t=!0){return this.renderable=t,this}}class v extends p{onInit(){return this}onUpdate(){return this}onAfterUpdate(){return this}}class S extends v{}const w=t.create(),y=e.create();class x extends f{constructor(){super(...arguments),this.needsUpdate=!0,this.localNeedsUpdate=!0}static getParentTransform(t){const e=t.getParent();return e?x.getTransform(e):null}static getTransform(t){}static getRequiredTransform(t){const e=x.getTransform(t);if(!e)throw new Error("Entity required a TransformComponent");return e}onDetach(){return this.setNeedsUpdate()}getParentTransform(){const t=this.getEntity();return t?x.getParentTransform(t):null}setNeedsUpdate(t=!0){if(this.setLocalNeedsUpdate(t),t!==this.needsUpdate){this.needsUpdate=t;const e=this.getEntity();if(e)for(const s of e.getChildren())for(const e of s.getComponentsInstanceOf(x))e.setNeedsUpdate(t)}return this}getNeedsUpdate(){return this.needsUpdate}setLocalNeedsUpdate(t=!0){return this.localNeedsUpdate=t,this}getLocalNeedsUpdate(){return this.localNeedsUpdate}updateLocalMatrixIfNeeded(){return this.localNeedsUpdate?(this.localNeedsUpdate=!1,this.updateLocalMatrix()):this}updateMatrixIfNeeded(){return this.needsUpdate?(this.needsUpdate=!1,this.updateMatrix()):this}translate2(e){const s=this.getLocalPosition2(w);return t.add(s,s,e),this.setLocalPosition2(s)}translate3(t){const s=this.getLocalPosition3(y);return e.add(s,s,t),this.setLocalPosition3(s)}scale2(e){const s=this.getLocalScale2(w);return t.mul(s,s,e),this.setLocalPosition2(s)}scale3(t){const s=this.getLocalScale3(y);return e.mul(s,s,t),this.setLocalPosition3(s)}}x.Manager=S;class N{constructor(){this.min=t.fromValues(1/0,1/0),this.max=t.fromValues(-1/0,-1/0)}static create(){return new N}static fromValues(t,e){return N.set(N.create(),t,e)}static set(t,e,s){return N.setMin(t,e),N.setMax(t,s),t}static setMin(e,s){return t.copy(e.min,s),e}static setMax(e,s){return t.copy(e.max,s),e}static identity(e){return t.set(e.min,1/0,1/0),t.set(e.max,-1/0,-1/0),e}static expandPoint(e,s,i){return t.min(e.min,s.min,i),t.max(e.max,s.max,i),e}static union(e,s,i){return t.min(e.min,s.min,i.min),t.max(e.max,s.max,i.max),e}static intersects(t,e){return!this.notIntersects(t,e)}static notIntersects(t,e){return t.max[0]<e.min[0]||t.min[0]>e.max[0]||t.max[1]<e.min[1]||t.min[1]>e.max[1]}}const P=Math.PI/180,E=180/Math.PI,A=.5*Math.PI,C=2*Math.PI,R=1e-6;function O(t,e,s,i){const r=s[0],n=s[1],o=Math.cos(i),a=Math.sin(i);return t[0]=o*r,t[1]=a*r,t[2]=-a*n,t[3]=o*n,t[4]=e[0],t[5]=e[1],t}const M=t.create();function L(e,s){return t.set(e,t.len(t.set(M,s[0],s[1])),t.len(t.set(M,s[2],s[3])))}function U(e,s,i){return t.set(s,e[4],e[5]),L(i,e),b(e)}function b(t){return Math.atan2(t[2],t[0])}function q(t,e){return t[0]=Math.cos(e),t[1]=Math.sin(e),t}function I(t){const e=t[0],s=t[1],i=Math.atan2(s,e);return s<0?C+i:i}const _=t.create();function F(e){const s=t.copy(_,e),i=s[0];return s[0]=s[1],s[1]=i,I(s)}function j(e,s){const i=s[1]<e[1]?-1:1;return Math.acos(t.dot(e,s)/(t.len(e)*t.len(s)))*i}function J(t){return t<0?-1:1}function H(t,e,s){return t<e?e:t>s?s:t}function T(t){return Math.atan2(t[1],t[0])}function B(t,e){return t[0]=Math.cos(e),t[1]=Math.sin(e),t}function z(e,s,i){const r=t.squaredLength(i),n=t.dot(s,i);return t.scale(e,i,n/r)}function D(t){return t*E}function k(t){return t*P}function W(t,e){return Math.abs(t-e)<=1e-6*Math.max(1,Math.abs(t),Math.abs(e))}function $(t){return`#${(255*t[0]|0).toString(16)}${(255*t[1]|0).toString(16)}${(255*t[2]|0).toString(16)}`}function V(t){return`rgb(${255*t[0]}, ${255*t[1]}, ${255*t[2]})`}function Y(t){return`rgba(${255*t[0]}, ${255*t[1]}, ${255*t[2]}, ${t[3]})`}function X(t,e){return s.set(t,e[0],e[1],0,e[4],e[2],e[3],0,e[5],0,0,1,0,0,0,0,1)}function Z(t,e){return i.set(t,e[0],e[1],e[4],e[5],e[13],e[14])}const Q=[t.create(),t.create(),t.create(),t.create()];function K(e,s,i,r){const n=Q,o=.5*r[0],a=.5*r[1];return N.identity(e),t.set(n[0],s[0]-o,s[1]-a),t.set(n[1],s[0]-o,s[1]+a),t.set(n[2],s[0]+o,s[1]+a),t.set(n[3],s[0]+o,s[1]-a),n.forEach((r=>{t.rotate(r,r,s,i),N.expandPoint(e,e,r)})),e}const G=t.create(),tt=e.fromValues(0,0,1),et=i.create();class st extends x{constructor(){super(...arguments),this.localPosition=t.create(),this.localScale=t.fromValues(1,1),this.localRotation=0,this.localMatrix=i.create(),this.position=t.create(),this.scale=t.fromValues(1,1),this.rotation=0,this.matrix=i.create()}getLocalPosition2(e){return t.copy(e,this.getLocalPosition())}getLocalPosition3(t){const e=this.getLocalPosition();return t[0]=e[0],t[1]=e[1],t}setLocalPosition2(t){return this.setLocalPosition(t)}setLocalPosition3(e){return this.setLocalPosition(t.set(G,e[0],e[1]))}getPosition2(e){return t.copy(e,this.getPosition())}getPosition3(t){const e=this.getPosition();return t[0]=e[0],t[1]=e[1],t}getLocalRotationZ(){return this.getLocalRotation()}getLocalRotationQuat(t){return r.fromEuler(t,0,0,this.getLocalRotation())}setLocalRotationZ(t){return this.setLocalRotation(t)}setLocalRotationQuat(t){return this.setLocalRotation(r.getAxisAngle(tt,t))}getRotationZ(){return this.getRotation()}getRotationQuat(t){return r.fromEuler(t,0,0,this.getRotation())}getLocalScale2(e){return t.copy(e,this.getLocalScale())}getLocalScale3(t){const e=this.getLocalScale();return t[0]=e[0],t[1]=e[1],t}setLocalScale2(t){return this.setLocalScale(t)}setLocalScale3(e){return this.setLocalScale(t.set(G,e[0],e[1]))}getScale2(e){return t.copy(e,this.getScale())}getScale3(t){const e=this.getScale();return t[0]=e[0],t[1]=e[1],t}setLocalPosition(e){return t.copy(this.localPosition,e),this.setNeedsUpdate()}getPosition(){return this.updateMatrixIfNeeded().position}getLocalPosition(){return this.localPosition}setLocalScale(e){return t.copy(this.localScale,e),this.setNeedsUpdate()}getScale(){return this.updateMatrixIfNeeded().scale}getLocalScale(){return this.localScale}setLocalRotation(t){return this.localRotation=t,this.setNeedsUpdate()}getRotation(){return this.updateMatrixIfNeeded().rotation}getLocalRotation(){return this.localRotation}getMatrix(){return this.updateMatrixIfNeeded().matrix}getLocalMatrix(){return this.updateLocalMatrixIfNeeded().localMatrix}updateLocalMatrix(){return O(this.localMatrix,this.localPosition,this.localScale,this.localRotation),this}updateMatrix(){this.updateLocalMatrixIfNeeded();const e=this.getParentTransform();return e?(i.mul(this.matrix,e.getMatrix2d(et),this.localMatrix),this.rotation=U(this.matrix,this.position,this.scale)):(i.copy(this.matrix,this.localMatrix),t.copy(this.position,this.localPosition),t.copy(this.scale,this.localScale),this.rotation=this.localRotation),this}getMatrix4(t){return X(t,this.getMatrix())}getMatrix2d(t){return i.copy(t,this.getMatrix())}getLocalMatrix4(t){return X(t,this.getLocalMatrix())}getLocalMatrix2d(t){return i.copy(t,this.getLocalMatrix())}toLocalPosition(e,s){return t.sub(e,s,this.getPosition())}lookAt(t){return this.setLocalRotation(j(this.localPosition,this.toLocalPosition(G,t))-A)}toJSON(){return Object.assign(Object.assign({},super.toJSON()),{localPosition:this.localPosition,localScale:this.localScale,localRotation:this.localRotation})}fromJSON(t){return super.fromJSON(t).setLocalPosition(t.localPosition).setLocalScale(t.localScale).setLocalRotation(t.localRotation)}}const it=s.create(),rt=r.create(),nt=e.create(),ot=e.fromValues(0,0,1);class at extends x{constructor(){super(...arguments),this.localPosition=e.create(),this.localScale=e.fromValues(1,1,1),this.localRotation=r.identity(r.create()),this.localMatrix=s.create(),this.position=e.create(),this.scale=e.fromValues(1,1,1),this.rotation=r.identity(r.create()),this.matrix=s.create()}getLocalPosition3(t){return e.copy(t,this.getLocalPosition())}getLocalPosition2(t){const e=this.getLocalPosition();return t[0]=e[0],t[1]=e[1],t}setLocalPosition2(t){return this.setLocalPosition(e.set(nt,t[0],t[1],this.localPosition[2]))}setLocalPosition3(t){return this.setLocalPosition(t)}getPosition3(t){return e.copy(t,this.getPosition())}getPosition2(t){const e=this.getPosition();return t[0]=e[0],t[1]=e[1],t}getLocalRotationQuat(t){return r.copy(t,this.localRotation)}getLocalRotationZ(){return r.getAxisAngle(ot,this.localRotation)}setLocalRotationZ(t){const e=r.copy(rt,this.getLocalRotation());return r.rotateZ(e,e,t),this.setLocalRotation(e)}setLocalRotationQuat(t){return this.setLocalRotation(t)}getRotationQuat(t){return r.copy(t,this.getRotation())}getRotationZ(){return r.getAxisAngle(ot,this.getRotation())}getLocalScale3(t){return e.copy(t,this.getLocalScale())}getLocalScale2(t){const e=this.getLocalScale();return t[0]=e[0],t[1]=e[1],t}setLocalScale2(t){return this.setLocalScale(e.set(nt,t[0],t[1],this.localScale[2]))}setLocalScale3(t){return this.setLocalScale(t)}getScale3(t){return e.copy(t,this.getScale())}getScale2(t){const e=this.getScale();return t[0]=e[0],t[1]=e[1],t}setLocalPosition(t){return e.copy(this.localPosition,t),this.setNeedsUpdate()}getPosition(){return this.updateMatrixIfNeeded().position}getLocalPosition(){return this.localPosition}setLocalScale(t){return e.copy(this.localScale,t),this.setNeedsUpdate()}getScale(){return this.updateMatrixIfNeeded().scale}getLocalScale(){return this.localScale}setLocalRotation(t){return r.copy(this.localRotation,t),this.setNeedsUpdate()}getRotation(){return this.updateMatrixIfNeeded().rotation}getLocalRotation(){return this.localRotation}getMatrix(){return this.updateMatrixIfNeeded().matrix}getLocalMatrix(){return this.updateLocalMatrixIfNeeded().localMatrix}updateLocalMatrix(){return s.fromRotationTranslationScale(this.localMatrix,this.localRotation,this.localPosition,this.localScale),this}updateMatrix(){this.updateLocalMatrixIfNeeded();const t=this.getParentTransform();return t?(s.mul(this.matrix,t.getMatrix4(it),this.localMatrix),s.getRotation(this.rotation,this.matrix),s.getScaling(this.scale,this.matrix),s.getTranslation(this.position,this.matrix)):(s.copy(this.matrix,this.localMatrix),e.copy(this.position,this.localPosition),e.copy(this.scale,this.localScale),r.copy(this.rotation,this.localRotation)),this}getMatrix4(t){return s.copy(t,this.getMatrix())}getMatrix2d(t){return Z(t,this.getMatrix())}getLocalMatrix4(t){return s.copy(t,this.getLocalMatrix())}getLocalMatrix2d(t){return Z(t,this.getLocalMatrix())}toLocalPosition(t,s){return e.sub(t,s,this.getPosition())}lookAt(t,e=ot){return s.getRotation(this.localRotation,s.targetTo(it,this.localPosition,this.toLocalPosition(nt,t),e)),this.setNeedsUpdate()}toJSON(){return Object.assign(Object.assign({},super.toJSON()),{localPosition:this.localPosition,localScale:this.localScale,localRotation:this.localRotation})}fromJSON(t){return super.fromJSON(t).setLocalPosition(t.localPosition).setLocalScale(t.localScale).setLocalRotation(t.localRotation)}}class ht extends v{constructor(){super(...arguments),this.active=null}setActive(t){if(t.getManager()!==this)throw new Error("Camera2DManager.setActive(camera: Camera2D): cannot set active if camera is not in manager");return this.active=t,this}getActive(){return this.active}getRequiredActive(){if(!this.active)throw new Error("Expected an Active Camera");return this.active}addComponent(t){return super.addComponent(t),null===this.active&&(this.active=t),this}removeComponent(t){return super.removeComponent(t),this.active&&this.active===t&&(this.active=null),this}}const ut=i.create(),ct=t.create(),lt=[t.create(),t.create(),t.create(),t.create()];class dt extends f{constructor(){super(...arguments),this.width=1,this.height=1,this.aspect=1,this.size=1,this.minSize=Number.EPSILON,this.maxSize=1/0,this.projection=i.identity(i.create()),this.view=i.identity(i.create()),this.needsUpdate=!0,this.background=n.create()}getBackground(){return this.background}setBackground(t){return n.copy(this.background,t),this}set(t,e){return t!==this.width||e!==this.height?(this.width=t,this.height=e,this.aspect=t/e,this.setNeedsUpdate()):this}getWidth(){return this.width}setWidth(t){return this.set(t,this.height)}getHeight(){return this.height}setHeight(t){return this.set(this.width,t)}getAspect(){return this.aspect}getSize(){return this.size}setSize(t){return this.size=t<this.minSize?this.minSize:t>this.maxSize?this.maxSize:t,this.setNeedsUpdate()}getMinSize(){return this.minSize}setMinSize(t){return this.minSize=t,this.setNeedsUpdate()}getMaxSize(){return this.minSize}setMaxSize(t){return this.maxSize=t,this.setNeedsUpdate()}setZoom(e){const s=this.getEntity();if(s){const i=x.getTransform(s);i&&i.setLocalScale2(t.set(ct,e,e))}return this}getZoom(){const e=this.getEntity();if(e){const s=x.getTransform(e);if(s)return t.len(L(ct,s.getMatrix2d(ut)))*this.size}return this.size}getView(){const t=this.getEntity();if(t){const e=x.getTransform(t);e&&i.invert(this.view,e.getMatrix2d(ut))}return this.view}getProjection(){return this.updateProjectionIfNeeded().projection}getAABB2(e){const s=ut,r=lt;N.identity(e),t.set(r[0],0,0),t.set(r[1],this.width,0),t.set(r[2],this.width,this.height),t.set(r[3],0,this.height),i.mul(s,this.projection,this.view),i.invert(s,s);for(const i of r)i[0]=i[0]/this.width*2-1,i[1]=i[1]/this.height*-2+1,t.transformMat2d(i,i,s),N.expandPoint(e,e,i);return e}setNeedsUpdate(t=!0){return this.needsUpdate=t,this}updateProjectionIfNeeded(){return this.needsUpdate?this.updateProjection():this}isActive(){return this.getRequiredManager().getActive()===this}setActive(){return this.getRequiredManager().setActive(this),this}updateProjection(){const t=this.getSize(),e=t*this.aspect,s=-e,r=-t,n=e-s,o=t-r,a=(e+s)/n,h=(t+r)/o;return i.set(this.projection,2/n,0,0,2/o,-a,-h),this.needsUpdate=!1,this}toRelative(e,s){return this.toWorld(e,s),t.transformMat2d(e,e,this.view),e}toWorld(e,s){const r=ut;return e[0]=s[0]/this.width*2-1,e[1]=s[1]/this.height*-2+1,i.mul(r,this.projection,this.view),i.invert(r,r),t.transformMat2d(e,e,r),e}toScreen(e,s){const r=i.mul(ut,this.projection,this.view);return t.transformMat2d(e,s,r),e[0]=.5*(e[0]+1)*this.width,e[1]=.5*(1-e[1])*this.height,e}toJSON(){return Object.assign(Object.assign({},super.toJSON()),{width:this.width,height:this.height,background:this.background})}fromJSON(t){return super.fromJSON(t).set(t.width,t.height).setBackground(t.background)}}dt.Manager=ht,dt.requiredComponents=[[st,at]];class gt extends d{constructor(){super(...arguments),this.uuid=o(),this.name="",this.loaded=!1,this.loading=!1}getUUID(){return this.uuid}getName(){return this.name}setName(t){return this.name=t,this}isLoaded(){return this.loaded}isLoading(){return this.loading}load(){return this.loaded?Promise.resolve():(this.loading=!0,this.loadAsset().then((()=>{this.loading=!1,this.loaded=!0,this.emit("load")})).catch((t=>{throw this.loading=!0,this.emit("load-error",t),t})))}unload(){return this.loaded?this.unloadAsset().then((()=>{this.loaded=!1,this.emit("unload")})).catch((t=>{throw this.emit("unload-error",t),t})):Promise.resolve()}toJSON(){return Object.assign(Object.assign({},super.toJSON()),{uuid:this.uuid,name:this.name})}fromJSON(t){return super.fromJSON(t),this.uuid=t.uuid,this.name=t.name,this}}function pt(t,e){return t.reduce(((t,s)=>(Array.isArray(s)?s.some(e)||t.push(s):e(s)&&t.push(s),t)),[])}function mt(t){return Array.isArray(t)?`one of ${t.map(mt).join(", ")}`:t.name||t.typeId||"UnknownClass"}class ft extends d{constructor(){super(...arguments),this.scene=null}static getPluginPriority(){return this.pluginPriority}static getRequiredPlugins(){return this.requiredPlugins}getConstructor(){return Object.getPrototypeOf(this).constructor}getPluginPriority(){return Object.getPrototypeOf(this).constructor.getPluginPriority()}getRequiredPlugins(){return Object.getPrototypeOf(this).constructor.requiredPlugins}getPlugin(t){const e=this.getScene();return e?e.getPlugin(t):null}getRequiredPlugin(t){const e=this.getPlugin(t);if(!e)throw new Error(`${this.getConstructor()} required ${t} Plugin`);return e}getManager(t){const e=this.getScene();return e?e.getManager(t):null}getRequiredManager(t){const e=this.getManager(t);if(!e)throw new Error(`${this.getConstructor()} required ${t} Manager`);return e}validateRequirements(){const t=[];for(const e of this.getRequiredScene().getPlugins()){const s=pt(e.getRequiredPlugins(),(t=>!this.getRequiredScene().hasPlugin(t)));s.length>0&&t.push(...s)}if(t.length>0){const e=t.map((t=>`${mt(this.getConstructor())} Plugin requires ${mt(t)} Plugin`)).join("\n");throw new Error(e)}}UNSAFE_setScene(t){return this.scene=t,this}UNSAFE_removeScene(){return this.scene=null,this}getScene(){return this.scene}getRequiredScene(){const t=this.getScene();if(!t)throw new Error(`${this.getConstructor()} required a Scene`);return t}onInit(){return this}onAdd(){return this}onRemove(){return this}onAfterUpdate(){return this}onUpdate(){return this}}ft.pluginPriority=0,ft.requiredPlugins=[];class vt extends ft{constructor(){super(...arguments),this.assetMap={},this.assets=[],this.loadedAssets=[],this.loadingPromises=new Map,this.unloadingPromises=new Map}find(t){return this.assets.find(t)}findWithName(t){return this.find((e=>e.getName()===t))}findAll(t){return this.assets.filter(t)}findAllWithName(t){return this.findAll((e=>e.getName()===t))}isLoading(){return this.loadingPromises.size>0}getAsset(t){return this.assetMap[t]||null}getRequiredAsset(t){const e=this.getAsset(t);if(!e)throw new Error(`Required Asset ${t} not found`);return e}getAssets(){return this.assets}getLoadedAssets(){return this.loadedAssets}getLoadingAssets(){return Array.from(this.loadingPromises.keys())}getUnloadingAssets(){return Array.from(this.unloadingPromises.keys())}getUnloadedAssets(){return this.assets.filter((t=>!t.isLoaded()))}addAsset(...t){return this.addAssets(t)}addAssets(t){for(const e of t)this._addAsset(e);return this}removeAsset(...t){return this.removeAssets(t)}removeAssets(t){for(const e of t)this._removeAsset(e);return this}loadAll(){return this.loadAssets(this.getUnloadedAssets())}loadAllInBackground(){return this.loadAssetsInBackground(this.getUnloadedAssets())}loadAssetInBackground(...t){return this.loadAssetsInBackground(t)}loadAssetsInBackground(t){return this.loadAssets(t),this}unloadAssetInBackground(...t){return this.unloadAssetsInBackground(t)}unloadAssetsInBackground(t){return this.unloadAssets(t),this}loadAsset(...t){return this.loadAssets(t)}loadAssets(t){return Promise.all(t.map((t=>this._loadAsset(t))))}unloadAsset(...t){return this.unloadAssets(t)}unloadAssets(t){return Promise.all(t.map((t=>this._unloadAsset(t))))}_loadAsset(t){if(t.isLoaded())return Promise.resolve();{const e=this.loadingPromises.get(t);if(e)return e;{const e=t.load().then((()=>{this.loadingPromises.delete(t),this.loadedAssets.push(t)})).catch((e=>{throw this.loadingPromises.delete(t),e}));return this.loadingPromises.set(t,e),e}}}_unloadAsset(t){if(t.isLoaded()){const e=this.unloadingPromises.get(t);if(e)return e;{const e=t.load().then((()=>{this.unloadingPromises.delete(t),this.loadedAssets.splice(this.loadedAssets.indexOf(t),1)})).catch((e=>{throw this.unloadingPromises.delete(t),e}));return this.unloadingPromises.set(t,e),e}}return Promise.resolve()}_addAsset(t){const e=t.getUUID();return this.assetMap[e]||(this.assetMap[e]=t,this.assets.push(t)),this}_removeAsset(t){const e=t.getUUID();return this.assetMap[e]&&(delete this.assetMap[e],this.assets.splice(this.assets.indexOf(t),1)),this}toJSON(){return Object.assign(Object.assign({},super.toJSON()),{assets:this.assets.map((t=>t.toJSON()))})}fromJSON(t){return super.fromJSON(t),a(t.assets)&&this.addAssets(t.assets.map((t=>gt.newFromJSON(t)))),this}}class St extends gt{constructor(t,e){super(),this.json=null,this.src=t,this.options=e}getJSON(){return this.json}loadAsset(){return fetch(this.src,this.options).then((t=>t.json())).then((t=>{this.json=t}))}unloadAsset(){return this.json=null,Promise.resolve()}toJSON(){return Object.assign(Object.assign({},super.toJSON()),{src:this.src,options:this.options})}fromJSON(t){return super.fromJSON(t),this.src=t.src,this.options=t.options,this}}class wt extends gt{constructor(t){super(),this.json=t}getJSON(){return this.json}loadAsset(){return Promise.resolve()}unloadAsset(){return Promise.resolve()}toJSON(){return Object.assign(Object.assign({},super.toJSON()),{json:this.json})}fromJSON(t){return super.fromJSON(t),this.json=t.json,this}}class yt extends gt{}class xt extends d{constructor(){super(...arguments),this.renderer=null,this.enabled=!0}static getRendererHandlerPriority(){return this.rendererHandlerPriority}getEnabled(){return this.enabled}setEnabled(t=!0){return this.enabled=t,this}getConstructor(){return Object.getPrototypeOf(this).constructor}getRendererHandlerPriority(){return Object.getPrototypeOf(this).constructor.getRendererHandlerPriority()}UNSAFE_setRenderer(t){return this.renderer=t,this}UNSAFE_removeRenderer(){return this.renderer=null,this}getRenderer(){return this.renderer}getRequiredRenderer(){if(!this.renderer)throw new Error(`${this.getConstructor()} expected to be added to a Renderer first`);return this.renderer}getScene(){return this.renderer?this.renderer.getScene():null}getRequiredScene(){const t=this.getScene();if(!t)throw new Error(`${this.getConstructor()} required scene`);return t}getManager(t){const e=this.getScene();return e?e.getManager(t):null}getRequiredManager(t){const e=this.getManager(t);if(!e)throw new Error(`${this.getConstructor()} required ${t} Manager`);return e}getPlugin(t){const e=this.getScene();return e?e.getPlugin(t):null}getRequiredPlugin(t){const e=this.getPlugin(t);if(!e)throw new Error(`${this.getConstructor()} required ${t} Plugin`);return e}onAdd(){return this}onRemove(){return this}onBeforeRender(){return this}onRender(){return this}onAfterRender(){return this}toJSON(){return Object.assign(Object.assign({},super.toJSON()),{enabled:this.enabled})}fromJSON(t){return super.fromJSON(t),this.enabled=t.enabled,this}}class Nt extends ft{constructor(){super(...arguments),this.rendererHandlers=[],this.rendererHandlerMap=new Map,this.sortRendererHandlersFunction=(t,e)=>t.getRendererHandlerPriority()-e.getRendererHandlerPriority()}getRendererHandlers(){return this.rendererHandlers}getRendererHandler(t){return this.rendererHandlerMap.get(t)||null}addRendererHandlers(t){for(const e of t)this._addRendererHandler(e);return this.sortRendererHandlers()}addRendererHandler(...t){return this.addRendererHandlers(t)}removeRendererHandlers(t){for(const e of t)this._removeRendererHandler(e);return this.sortRendererHandlers()}removeRendererHandler(...t){return this.removeRendererHandlers(t)}onUpdate(){for(const t of this.rendererHandlers)t.getEnabled()&&(t.onBeforeRender(),t.onRender());return this}onAfterUpdate(){for(const t of this.rendererHandlers)t.getEnabled()&&t.onAfterRender();return this}_addRendererHandler(t){const e=t.getConstructor();return this.rendererHandlerMap.has(e)||(this.rendererHandlers.push(t),this.rendererHandlerMap.set(e,t),t.UNSAFE_setRenderer(this),t.onAdd(),this.emit("add-renderer_handler",t)),this}_removeRendererHandler(t){const e=this.rendererHandlerMap.get(t);return e&&(this.emit("remove-renderer_handler",e),e.onRemove(),this.rendererHandlers.splice(this.rendererHandlers.indexOf(e),1),this.rendererHandlerMap.delete(t),e.UNSAFE_removeRenderer()),this}sortRendererHandlers(){return this.rendererHandlers.sort(this.sortRendererHandlersFunction),this}toJSON(){return Object.assign(Object.assign({},super.toJSON()),{rendererHandlers:this.rendererHandlers.map((t=>t.toJSON()))})}fromJSON(t){return super.fromJSON(t),a(t.rendererHandlers)&&this.addRendererHandlers(t.rendererHandlers.map((t=>xt.newFromJSON(t)))),this}}Nt.pluginPriority=1/0;class Pt extends ft{constructor(){super(...arguments),this.scale=1,this.fixedDelta=1/60,this.frame=0,this.last=-1/60,this.current=0,this.delta=1/60,this.fps=60,this.fpsFrame=0,this.fpsLast=0,this.startTime=.001*Date.now(),this.minDelta=1e-6,this.maxDelta=1/0}getStartTime(){return this.startTime}getDelta(){return this.delta*this.scale}getRealDelta(){return this.delta*this.scale}getCurrent(){return this.current}getMinDelta(){return this.minDelta}setMinDelta(t){return this.minDelta=t,this}getMaxDelta(){return this.maxDelta}setMaxDelta(t){return this.maxDelta=t,this}getFrame(){return this.frame}getFps(){return this.fps}getScale(){return this.scale}setScale(t){return this.scale=t,this}getFixedDelta(){return this.fixedDelta*this.scale}setFixedDelta(t){return this.fixedDelta=t,this}now(){return.001*Date.now()-this.startTime}onUpdate(){return++this.frame,this.last=this.current,this.current=this.now(),this.fpsFrame++,this.fpsLast+1<this.current&&(this.fps=this.fpsFrame/(this.current-this.fpsLast),this.fpsLast=this.current,this.fpsFrame=0),this.delta=(this.current-this.last)*this.scale,this.delta=this.delta<this.minDelta?this.minDelta:this.delta>this.maxDelta?this.maxDelta:this.delta,this}toJSON(){return Object.assign(Object.assign({},super.toJSON()),{frame:this.frame,scale:this.scale,fixedDelta:this.fixedDelta})}fromJSON(t){return super.fromJSON(t),this.frame=t.frame,this.scale=t.scale,this.fixedDelta=t.fixedDelta,this}}Pt.pluginPriority=-1/0;class Et extends ft{constructor(){super(...arguments),this.queue=[],this.swap=[]}runOnUpdate(...t){return this.queue.push(...t),this}onUpdate(){if(this.queue.length>0){const t=this.queue;this.queue=this.swap,this.swap=t;for(const e of t)e.call(this);this.swap.length=0}return this}}class At extends d{constructor(){super(...arguments),this.input=null}getConstructor(){return Object.getPrototypeOf(this).constructor}UNSAFE_setInput(t){return this.input=t,this}UNSAFE_removeInput(){return this.input=null,this}getInput(){return this.input}getRequiredInput(){const t=this.getInput();if(!t)throw new Error(`${this.getConstructor()} requires a Input Plugin`);return t}getScene(){const t=this.getInput();return t?t.getScene():null}getRequiredScene(){const t=this.getScene();if(!t)throw new Error(`${this.getConstructor()} requires a Scene`);return t}queueEvent(t){const e=this.getInput();return e&&e.queueEvent(t),this}onAdd(){return this}onRemove(){return this}onUpdate(t){return this}onAfterUpdate(t){return this}}class Ct{constructor(t,e,s){this.gravity=3,this.sensitivity=3,this.dead=.001,this.value=0,this.name=t,this.negButton=e,this.posButton=s}getName(){return this.name}getNegButton(){return this.negButton}setNegButton(t){return this.negButton=t,this}getPosButton(){return this.posButton}setPosButton(t){return this.posButton=t,this}getGravity(){return this.gravity}setGravity(t){return this.gravity=t,this}getSensitivity(){return this.sensitivity}setSensitivity(t){return this.sensitivity=t,this}getDead(){return this.dead}setDead(t){return this.dead=t,this}getValue(){return this.value}UNSAFE_setValue(t){return this.value=t,this}UNSAFE_update(t,e,s,i){const r=t.getDelta();s&&(e-=this.getSensitivity()*r),i&&(e+=this.getSensitivity()*r),i||s||0===e||(e-=(e>=0?1:-1)*this.getGravity()*r),e=e>=1?1:e<=-1?-1:e,Math.abs(e)<=this.getDead()&&(e=0),this.value=e}toJSON(){return{name:this.name,negButton:this.negButton,posButton:this.posButton,gravity:this.gravity,sensitivity:this.sensitivity,dead:this.dead,value:this.value}}fromJSON(t){return this.name=t.name,this.negButton=t.negButton,this.posButton=t.posButton,this.gravity=t.gravity,this.sensitivity=t.sensitivity,this.dead=t.dead,this.value=t.value,this}}class Rt{constructor(t){this.value=0,this.frameDown=0,this.frameUp=0,this.name=t}getName(){return this.name}getFrameDown(){return this.frameDown}getFrameUp(){return this.frameUp}getValue(){return this.value}UNSAFE_setValue(t){return this.value=t,this}UNSAFE_up(t){return 1===this.value&&(this.frameUp=t),this.value=0,this}UNSAFE_down(t){return 0===this.value&&(this.frameDown=t),this.value=1,this}toJSON(){return{name:this.name,value:this.value,frameDown:this.frameDown,frameUp:this.frameUp}}fromJSON(t){return this.name=t.name,this.value=t.value,this.frameDown=t.frameDown,this.frameUp=t.frameUp,this}}class Ot extends d{constructor(){super(...arguments),this.input=null}getConstructor(){return Object.getPrototypeOf(this).constructor}UNSAFE_setInput(t){return this.input=t,this}UNSAFE_removeInput(){return this.input=null,this}getInput(){return this.input}getRequiredInput(){const t=this.getInput();if(!t)throw new Error(`${this.getConstructor()} requires a Input Plugin`);return t}getScene(){const t=this.getInput();return t?t.getScene():null}getRequiredScene(){const t=this.getScene();if(!t)throw new Error(`${this.getConstructor()} requires a Scene`);return t}onAdd(){return this}onRemove(){return this}onUpdate(t){return this}onAfterUpdate(t){return this}}class Mt extends Ot{onEvent(t,e){const s=this.getRequiredInput();switch(e.type){case"mousemove":s.getOrCreateButton("mouse-x").UNSAFE_setValue(e.x),s.getOrCreateButton("mouse-y").UNSAFE_setValue(e.y);break;case"mousedown":s.getOrCreateButton("mouse-x").UNSAFE_setValue(e.x),s.getOrCreateButton("mouse-y").UNSAFE_setValue(e.y),s.getOrCreateButton(`mouse-${e.button}`).UNSAFE_down(t.getFrame());break;case"mouseup":case"mouseleave":s.getOrCreateButton("mouse-x").UNSAFE_setValue(e.x),s.getOrCreateButton("mouse-y").UNSAFE_setValue(e.y),s.getOrCreateButton(`mouse-${e.button}`).UNSAFE_up(t.getFrame());break;case"wheel":s.getOrCreateButton("mouse-wheel").UNSAFE_setValue(e.wheel)}return this}onAfterUpdate(){return this.getRequiredInput().getOrCreateButton("mouse-wheel").UNSAFE_setValue(0),this}}class Lt extends Ot{onEvent(t,e){const s=this.getRequiredInput();switch(e.type){case"keydown":s.getOrCreateButton(e.code).UNSAFE_down(t.getFrame());break;case"keyup":s.getOrCreateButton(e.code).UNSAFE_up(t.getFrame())}return this}}class Ut extends Ot{onEvent(t,e){const s=this.getRequiredInput();switch(e.type){case"touchstart":s.getOrCreateButton(`touch-${e.id}-x`).UNSAFE_setValue(e.x),s.getOrCreateButton(`touch-${e.id}-y`).UNSAFE_setValue(e.y),s.getOrCreateButton(`touch-${e.id}`).UNSAFE_down(t.getFrame());break;case"touchmove":s.getOrCreateButton(`touch-${e.id}-x`).UNSAFE_setValue(e.x),s.getOrCreateButton(`touch-${e.id}-y`).UNSAFE_setValue(e.y);break;case"touchend":s.getOrCreateButton(`touch-${e.id}`).UNSAFE_up(t.getFrame())}return this}}class bt extends Ot{onEvent(t,e){const s=this.getRequiredInput();if("resize"===e.type)s.getOrCreateButton("screen-width").UNSAFE_setValue(e.width),s.getOrCreateButton("screen-height").UNSAFE_setValue(e.height);return this}}class qt extends ft{constructor(){super(),this.events=[],this.inputHandlers=[],this.inputHandlerMap=new Map,this.eventListeners=[],this.eventListenerMap=new Map,this.buttons={},this.axes={},this.addInputHandler(new Mt,new Lt,new Ut,new bt),this.addAxis(new Ct("horizontal-keys","ArrowLeft","ArrowRight"),new Ct("vertical-keys","ArrowDown","ArrowUp"))}queueEvent(t){return this.emit("event",t),this.events.push(t),this}addAxes(t){for(const e of t)this._addAxis(e);return this}addAxis(...t){return this.addAxes(t)}getAxis(t){return this.axes[t]||null}getAxisValue(t){const e=this.getAxis(t);return e?e.getValue():0}getRequiredAxis(t){const e=this.getAxis(t);if(!e)throw new Error(`Failed to get Required Axis ${t}`);return e}getInputHandler(t){return this.inputHandlerMap.get(t)||null}getRequiredInputHandler(t){const e=this.getInputHandler(t);if(!e)throw new Error(`Failed to get Required InputHandler ${t}`);return e}getEventListener(t){return this.eventListenerMap.get(t)||null}getRequiredEventListener(t){const e=this.getEventListener(t);if(!e)throw new Error(`Failed to get Required EventListener ${t}`);return e}removeAxes(t){for(const e of t)this._removeAxis(e);return this}removeAxis(...t){return this.removeAxes(t)}addInputHandlers(t){for(const e of t)this._addInputHandler(e);return this}addInputHandler(...t){return this.addInputHandlers(t)}removeInputHandlers(t){for(const e of t)this._removeInputHandler(e);return this}removeInputHandler(...t){return this.removeInputHandlers(t)}addEventListeners(t){for(const e of t)this._addEventListener(e);return this}addEventListener(...t){return this.addEventListeners(t)}removeEventListeners(t){for(const e of t)this._removeEventListener(e);return this}removeEventListener(...t){return this.removeEventListeners(t)}getOrCreateButton(t){const e=this.buttons[t];if(e)return e;{const e=new Rt(t);return this.buttons[t]=e,e}}getButton(t){return this.buttons[t]||null}getButtonValue(t){const e=this.getButton(t);return e?e.getValue():0}isDownCurrentFrame(t){var e;return(null===(e=this.getButton(t))||void 0===e?void 0:e.getFrameDown())===this.getRequiredPlugin(Pt).getFrame()}isDown(t){return!this.isUp(t)}isUpCurrentFrame(t){var e;return(null===(e=this.getButton(t))||void 0===e?void 0:e.getFrameUp())===this.getRequiredPlugin(Pt).getFrame()}isUp(t){return 0==this.getButtonValue(t)}onUpdate(){const t=this.getRequiredPlugin(Pt);for(const e of this.eventListeners)e.onUpdate(t);for(const e of this.inputHandlers){for(const s of this.events)e.onEvent(t,s);e.onUpdate(t)}for(const t of this.events)this.emit(t.type,t);for(const t of this.eventListeners)for(let e=0;e<this.events.length;e++){const s=this.events[e];t.dequeueEvent(s)&&(this.events.splice(e,1),e--)}return this.events.length=0,this.updateAxes(t),this}onAfterUpdate(){const t=this.getRequiredPlugin(Pt);for(const e of this.eventListeners)e.onAfterUpdate(t);for(const e of this.inputHandlers)e.onAfterUpdate(t);return this}_addAxis(t){return this.axes[t.getName()]||(this.axes[t.getName()]=t),this}_removeAxis(t){return this.axes[t.getName()]&&delete this.axes[t.getName()],this}updateAxes(t){for(const e of Object.values(this.axes))this.updateAxis(e,t)}updateAxis(t,e){const s=this.getButtonValue(t.getPosButton()),i=this.getButtonValue(t.getNegButton());t.UNSAFE_update(e,t.getValue(),0!==i,0!==s)}_addInputHandler(t){const e=t.getConstructor();return this.inputHandlerMap.has(e)||(this.inputHandlers.push(t),this.inputHandlerMap.set(e,t),t.UNSAFE_setInput(this),t.onAdd(),this.emit("add-input_handler",t)),this}_removeInputHandler(t){const e=this.getInputHandler(t);return e&&(this.emit("remove-input_handler",e),e.onRemove(),this.inputHandlers.splice(this.inputHandlers.indexOf(e),1),this.inputHandlerMap.delete(t),e.UNSAFE_removeInput()),this}_addEventListener(t){const e=t.getConstructor();return this.eventListenerMap.has(e)||(this.eventListeners.push(t),this.eventListenerMap.set(e,t),t.UNSAFE_setInput(this),t.onAdd(),this.emit("add-event_listener",t)),this}_removeEventListener(t){const e=this.getEventListener(t);return e&&(this.emit("remove-event_listener",e),e.onRemove(),this.eventListeners.splice(this.eventListeners.indexOf(e),1),this.eventListenerMap.delete(t),e.UNSAFE_removeInput()),this}toJSON(){return Object.assign(Object.assign({},super.toJSON()),{buttons:Object.values(this.buttons).map((t=>t.toJSON())),axes:Object.values(this.axes).map((t=>t.toJSON())),inputHandlers:this.inputHandlers.map((t=>t.toJSON()))})}fromJSON(t){if(super.fromJSON(t),a(t.buttons))for(const e of t.buttons){const t=e,s=new Rt(t.name).fromJSON(t);this.buttons[s.getName()]=s}return a(t.axes)&&this.addAxes(t.axes.map((t=>{const e=t;return new Ct(e.name,e.negButton,e.posButton).fromJSON(e)}))),a(t.inputHandlers)&&this.addInputHandlers(t.inputHandlers.map((t=>Ot.newFromJSON(t)))),this}}class It{constructor(t){this.type=t}static init(t,e){return t.type=e,t}}class _t extends It{constructor(){super(...arguments),this.code=""}}class Ft extends It{constructor(){super(...arguments),this.button=0,this.x=0,this.y=0}}class jt extends It{constructor(){super(...arguments),this.wheel=0}}class Jt extends It{constructor(){super(...arguments),this.width=0,this.height=0}}class Ht extends It{constructor(){super(...arguments),this.id=0,this.x=0,this.y=0}}class Tt extends Et{constructor(t){super(),this.onResizeEventListener=()=>{this.runOnUpdate(this.onResize)},this.canvas=t}getCanvas(){return this.canvas}onAdd(){return this.getRequiredPlugin(qt).on("resize",this.onResizeEventListener),this}onRemove(){return this.getRequiredPlugin(qt).off("resize",this.onResizeEventListener),this}onResize(){const t=this.getRequiredPlugin(qt);this.canvas.set(t.getButtonValue("screen-width"),t.getButtonValue("screen-height"))}}Tt.toFromJSONEnabled=!1,Tt.requiredPlugins=[qt];const Bt="undefined"!=typeof window?window:{},zt="undefined"!=typeof performance?performance:Date;let Dt=Bt.requestAnimationFrame&&Bt.requestAnimationFrame.bind(Bt),kt=Bt.cancelAnimationFrame&&Bt.cancelAnimationFrame.bind(Bt);if(!Dt||!kt){let t=0;Dt=e=>{const s=zt.now(),i=Math.max(t+1e3/60,s);return setTimeout((()=>{e(t=i)}),i-s)},kt=t=>clearTimeout(t)}class Wt extends ft{constructor(){super(...arguments),this.id=null,this.running=!1,this.start=()=>{this.running||(this.running=!0,this.request())},this.run=t=>(this.id=null,this.getRequiredScene().update(),this.running=!1,this)}onInit(){return this.getRequiredPlugin(qt).on("event",this.start),this.start(),this}onRemove(){return this.getRequiredPlugin(qt).off("event",this.start),this}stop(){return this.running=!1,null!==this.id&&(kt(this.id),this.id=null),this}isStopped(){return!1===this.running}request(){return this.id=Dt(this.run),this}}Wt.requiredPlugins=[qt];class $t extends ft{constructor(){super(...arguments),this.id=null,this.running=!1,this.resolves=[],this.run=t=>{if(this.getRequiredScene().update(),this.running)this.request();else if(this.resolves.length){const t=this.resolves;this.resolves=[];for(const e of t)e()}return this}}promise(){return this.running?new Promise((t=>this.resolves.push(t))):Promise.resolve()}start(){this.running||(this.running=!0,this.request())}stop(){return this.running=!1,null!==this.id&&(kt(this.id),this.id=null),this}isStopped(){return!1===this.running}request(){return this.id=Dt(this.run),this}onInit(){return this.start(),this}}class Vt extends p{onInit(){return this}onAfterUpdate(){return this}}const Yt=t.create(),Xt=t.create(),Zt=t.create(),Qt=t.fromValues(0,0),Kt=t.fromValues(1e-6,1e-6);class Gt extends f{constructor(){super(...arguments),this.enabled=!0,this.panSpeed=1,this.zoomSpeed=1,this.dragging=!1,this.lastMouse=t.create(),this.offset=t.create()}getEnabled(){return this.enabled}setEnabled(t=!0){return this.enabled=t,this}getPanSpeed(){return this.panSpeed}setPanSpeed(t){return this.panSpeed=t,this}getZoomSpeed(){return this.zoomSpeed}setZoomSpeed(t){return this.zoomSpeed=t,this}onUpdate(){const e=this.getRequiredPlugin(qt),s=x.getRequiredTransform(this.getRequiredEntity()),i=s.getLocalScale2(Xt),r=this.getRequiredComponent(dt).toRelative(Yt,t.set(Yt,-e.getButtonValue("mouse-x"),-e.getButtonValue("mouse-y")));this.dragging&&(t.sub(this.offset,r,this.lastMouse),t.scale(this.offset,this.offset,this.panSpeed),t.mul(this.offset,this.offset,i),t.rotate(this.offset,this.offset,Qt,s.getRotationZ()),this.enabled&&s.translate2(this.offset)),e.isDown("mouse-0")?this.dragging=!0:this.dragging=!1;const n=e.getButtonValue("mouse-wheel"),o=t.set(Zt,this.zoomSpeed,this.zoomSpeed);return 0!==n&&this.enabled&&(n>0?t.add(i,i,o):n<0&&(t.sub(i,i,o),t.max(i,Kt,i)),s.setLocalScale2(i)),t.copy(this.lastMouse,r),this}toJSON(){return Object.assign(Object.assign({},super.toJSON()),{enabled:this.enabled,zoomSpeed:this.zoomSpeed,panSpeed:this.panSpeed})}fromJSON(t){return this.setEnabled(t.enabled),this.setZoomSpeed(t.zoomSpeed),this.setPanSpeed(t.panSpeed),this}}Gt.Manager=Vt,Gt.requiredComponents=[[st,at]],Gt.requiredPlugins=[qt];class te extends v{constructor(){super(...arguments),this.active=null}setActive(t){if(t.getManager()!==this)throw new Error("Camera3DManager.setActive(camera: Camera3D): cannot set active if camera is not in manager");return this.active=t,this}getActive(){return this.active}getRequiredActive(){if(this.active)throw new Error("Expected an Active Camera");return this.active}addComponent(t){return super.addComponent(t),null===this.active&&(this.active=t),this}removeComponent(t){return super.removeComponent(t),this.active&&this.active===t&&(this.active=null),this}}const ee=s.create(),se=t.create();class ie extends f{constructor(){super(...arguments),this.width=1,this.height=1,this.aspect=1,this.orthographic=!1,this.size=1,this.minSize=Number.EPSILON,this.maxSize=1/0,this.fov=16,this.near=1e-6,this.far=1024,this.projection=s.identity(s.create()),this.view=s.identity(s.create()),this.needsUpdate=!0,this.background=n.create()}getBackground(){return this.background}setBackground(t){return n.copy(this.background,t),this}set(t,e){return t!==this.width||e!==this.height?(this.width=t,this.height=e,this.aspect=t/e,this.setNeedsUpdate()):this}getWidth(){return this.width}setWidth(t){return this.set(t,this.height)}getHeight(){return this.height}setHeight(t){return this.set(this.width,t)}getAspect(){return this.aspect}getSize(){return this.size}setSize(t){return this.size=t<this.minSize?this.minSize:t>this.maxSize?this.maxSize:t,this.setNeedsUpdate()}getMinSize(){return this.minSize}setMinSize(t){return this.minSize=t,this.setNeedsUpdate()}getMaxSize(){return this.minSize}setMaxSize(t){return this.maxSize=t,this.setNeedsUpdate()}getFov(){return this.fov}setFov(t){return this.fov=t,this.setNeedsUpdate()}getNear(){return this.near}setNear(t){return this.near=t,this.setNeedsUpdate()}getFar(){return this.far}setFar(t){return this.far=t,this.setNeedsUpdate()}getView(){const t=this.getEntity();if(t){const e=x.getTransform(t);e&&s.invert(this.view,e.getMatrix4(ee))}return this.view}getProjection(){return this.updateProjectionIfNeeded().projection}setNeedsUpdate(t=!0){return this.needsUpdate=t,this}updateProjectionIfNeeded(){return this.needsUpdate?this.updateProjection():this}isActive(){return this.getRequiredManager().getActive()===this}setActive(){return this.getRequiredManager().setActive(this),this}updateProjection(){if(this.orthographic){const t=this.size*this.aspect,e=-t,i=this.size,r=-i;s.ortho(this.projection,e,t,r,i,this.near,this.far)}else s.perspective(this.projection,this.fov,this.aspect,this.near,this.far);return this.needsUpdate=!1,this}toRelative(t,s){return this.toWorld(t,s),e.transformMat4(t,t,this.getView()),t}toWorld(t,i){const r=ee;return t[0]=i[0]/this.width*2-1,t[1]=i[1]/this.height*-2+1,t[2]=this.near,s.mul(r,this.projection,this.getView()),s.invert(r,r),e.transformMat4(t,t,r),t}toScreen(e,i){const r=s.mul(ee,this.getProjection(),this.getView());return se[0]=i[0],se[1]=i[1],t.transformMat4(e,se,r),e[0]=.5*(e[0]+1)*this.width,e[1]=.5*(1-e[1])*this.height,e}toJSON(){return Object.assign(Object.assign({},super.toJSON()),{width:this.width,height:this.height,size:this.size,fov:this.fov,near:this.near,far:this.far,background:this.background})}fromJSON(t){return super.fromJSON(t).set(t.width,t.height).setSize(t.size).setFov(t.fov).setNear(t.near).setFar(t.far).setBackground(t.background)}}ie.Manager=te,ie.requiredComponents=[[st,at]];class re extends v{constructor(){super(...arguments),this.layers={},this.sortFunction=(t,e)=>t.getRequiredEntity().getDepth()-e.getRequiredEntity().getDepth()}isEmpty(){return 0===Object.values(this.layers).length}getComponents(){return[].concat(...Object.values(this.layers))}addComponent(t){return this.getOrCreateLayer(t.getLayer()).push(t),this}removeComponent(t){const e=t.getLayer(),s=this.layers[e];if(s){const i=s.indexOf(t);-1!==i&&(s.splice(i,1),0===s.length&&delete this.layers[e])}return this}sort(){for(const t of Object.values(this.layers))t.sort(this.sortFunction);return this}getOrCreateLayer(t){const e=this.layers[t];if(e)return e;{const e=[];return this.layers[t]=e,e}}}class ne extends f{constructor(){super(...arguments),this.layer=0,this.imageAsset=null,this.clipX=0,this.clipY=0,this.clipWidth=1,this.clipHeight=1,this.width=1,this.height=1,this.onImageLoadHandler=()=>{this.imageAsset&&(this.clipWidth=this.imageAsset.getWidth(),this.clipHeight=this.imageAsset.getHeight(),this.imageAsset.off("load",this.onImageLoadHandler))}}getClipX(){return this.clipX}setClipX(t){return this.clipX=t,this}getClipY(){return this.clipY}setClipY(t){return this.clipY=t,this}getClipWidth(){return this.clipWidth}setClipWidth(t){return this.clipWidth=t,this}getClipHeight(){return this.clipHeight}setClipHeight(t){return this.clipHeight=t,this}getSize(t){return t[0]=this.width,t[1]=this.height,t}getWidth(){return this.width}setWidth(t){return this.width=t,this}getHeight(){return this.height}setHeight(t){return this.height=t,this}getLayer(){return this.layer}setLayer(t){const e=this.getManager();return null==e||e.removeComponent(this),this.layer=0|t,null==e||e.addComponent(this),this}getImageAsset(){return this.imageAsset}setImageAsset(t){return this.imageAsset=t,t.isLoaded()?this.onImageLoadHandler():t.on("load",this.onImageLoadHandler),this}toJSON(){return Object.assign(Object.assign({},super.toJSON()),{imageAssetUUID:this.imageAsset?this.imageAsset.getUUID():null,layer:this.layer,clipX:this.clipX,clipY:this.clipY,clipWidth:this.clipWidth,clipHeight:this.clipHeight,width:this.width,height:this.height})}fromJSON(t){const e=()=>{this.setImageAsset(this.getRequiredPlugin(vt).getRequiredAsset(t.imageAssetUUID)),this.off("add-to-scene",e)};return this.on("add-to-scene",e),super.fromJSON(t).setLayer(t.layer).setClipX(t.clipX).setClipY(t.clipY).setClipWidth(t.clipWidth).setClipHeight(t.clipHeight).setWidth(t.width).setHeight(t.height)}}ne.requiredPlugins=[vt],ne.Manager=re;class oe{constructor(){this.duration=1,this.x=0,this.y=0,this.width=1,this.height=1}getDuration(){return this.duration}setDuration(t){return this.duration=t,this}getX(){return this.x}setX(t){return this.x=t,this}getY(){return this.y}setY(t){return this.y=t,this}getWidth(){return this.width}setWidth(t){return this.width=t,this}getHeight(){return this.height}setHeight(t){return this.height=t,this}toJSON(){return{duration:this.duration,x:this.x,y:this.y,width:this.width,height:this.height}}fromJSON(t){return this.duration=t.duration,this.x=t.x,this.y=t.y,this.width=t.width,this.height=t.height,this}}class ae extends m{constructor(){super(...arguments),this.currentTime=0,this.currentFrame=0,this.playBack=1,this.currentName=null,this.spriteSheets={}}get(t){return this.spriteSheets[t]}set(t,e){return this.spriteSheets[t]=e,this}getPlayBack(){return this.playBack}setPlayBack(t){return this.playBack=t,this}setCurrent(t){if(!this.spriteSheets.hasOwnProperty(t))throw new Error(`SpriteSheet setCurrent(name: string) no SpriteSheet found named ${t}`);return this.currentName=t,this.currentFrame=0,this.currentTime=0,this}getCurrent(){return this.currentName?this.get(this.currentName):null}onUpdate(){const t=this.getCurrent();if(t){const e=t[this.currentFrame];if(e){const s=this.getRequiredComponent(ne);s.setClipX(e.getX()),s.setClipY(e.getY()),s.setClipWidth(e.getWidth()),s.setClipHeight(e.getHeight()),this.currentTime>=e.getDuration()&&(this.currentTime=0,this.currentFrame+=1,this.currentFrame>=t.length&&(this.currentFrame=0)),this.currentTime+=this.getRequiredPlugin(Pt).getDelta()*this.playBack}}return this}}ae.requiredComponents=[ne],ae.requiredPlugins=[Pt];class he extends f{constructor(){super(...arguments),this.queue=[],this.swap=[]}runOnUpdate(...t){return this.queue.push(...t),this}onUpdate(){if(this.queue.length>0){const t=this.queue;this.queue=this.swap,this.swap=t;for(const e of t)e.call(this);this.swap.length=0}return this}}x.getTransform=function(t){const e=t.getComponent(st)||t.getComponent(at);return e||x.getParentTransform(t)};class ue extends d{constructor(){super(...arguments),this.name=null,this.depth=0,this.scene=null,this.root=this,this.parent=null,this.tags=new Set,this.children=[],this.components=new Map}getName(){return this.name}setName(t){return this.name=t,this}removeName(){return this.name=null,this}hasTags(t){return t.every((t=>this.tags.has(t)))}hasTag(...t){return this.hasTags(t)}getTags(){return this.tags}addTags(t){for(const e of t)this.tags.add(e);return this}removeTag(...t){return this.removeTags(t)}removeTags(t){for(const e of t)this.tags.delete(e);return this}clearTags(){return this.tags.clear(),this}addTag(...t){return this.addTags(t)}getDepth(){return this.depth}getRoot(){return this.root}isRoot(){return this.root===this}hasParent(){return null!==this.parent}getParent(){return this.parent}hasScene(){return null!==this.scene}getScene(){return this.scene}getRequiredScene(){const t=this.getScene();if(!t)throw new Error("Entity expected to have a Scene");return t}UNSAFE_setScene(t,e=!1){if(this.scene=t,e)for(const s of this.children)s.UNSAFE_setScene(t,e);return this}UNSAFE_removeScene(){return this.scene=null,this}forEachChild(t,e=!0){for(const s of this.getChildren()){if(!1===t(s))break;e&&s.forEachChild(t,e)}return this}find(t,e=!0){for(const s of this.getChildren()){if(t(s))return s;if(e){const i=s.find(t,e);if(i)return i}}}findWithName(t){return this.find((e=>e.name===t))}findWithTag(...t){return this.find((e=>e.hasTags(t)))}findWithTags(t){return this.findWithTag(...t)}findWithComponent(t){return this.find((e=>null!==e.getComponent(t)))}findAll(t,e=!0){const s=this.getChildren(),i=[];for(const r of s)t(r)?i.push(r):e&&i.push(...r.findAll(t,e));return i}findAllWithName(t,e=!0){return this.findAll((e=>t===e.name),e)}findAllWithTag(...t){return this.findAll((e=>e.hasTags(t)))}findAllWithTags(t){return this.findAllWithTag(...t)}findAllWithComponent(t,e=!0){return this.findAll((e=>null!==e.getComponent(t)),e)}findParent(t){const e=this.getParent();return e?t(e)?e:e.findParent(t):void 0}getComponents(){return this.components}hasComponent(t){return null!==this.getComponent(t)}getComponent(t){return this.components.get(t)||null}getRequiredComponent(t){const e=this.getComponent(t);if(!e)throw new Error(`Entity expected to have a ${t} Component`);return e}getComponentInstanceOf(t){for(const e of this.components.values())if(e instanceof t)return e;return null}getComponentsInstanceOf(t){return Array.from(this.components.values()).filter((e=>e instanceof t))}addComponents(t){for(const e of t)this._addComponent(e);return this}addComponent(...t){return this.addComponents(t)}removeComponents(t){for(const e of t)this._removeComponent(e);return this}removeComponent(...t){return this.removeComponents(t)}removeFromScene(){const t=this.scene;t&&t.removeEntity(this)}detach(){const t=this.parent;if(t){t._removeChild(this);const e=this.scene;e&&e.addEntity(this);for(const t of this.components.values())t.onDetach()}}getChildren(){return this.children}addChildren(t){for(const e of t)this._addChild(e);return this}addChild(...t){return this.addChildren(t)}removeChildren(t){for(const e of t)this._removeChild(e);return this}removeChild(...t){return this.removeChildren(t)}validateRequirements(){const t=new Map,e=new Map;for(const[s,i]of this.components){const r=pt(i.getRequiredComponents(),(t=>!this.hasComponent(t))),n=pt(i.getRequiredPlugins(),(t=>!this.getRequiredScene().hasPlugin(t)));r.length>0&&t.set(s,r),r.length>0&&e.set(s,n)}if(t.size>0||e.size>0){const s=[...t.entries()].map((([t,e])=>e.map((e=>`Entity's ${mt(t)} requires ${mt(e)} Component`)).join("\n"))).join("\n"),i=[...e.entries()].map((([t,e])=>e.map((e=>`Entity's ${mt(t)} requires ${mt(e)} Plugin`)).join("\n"))).join("\n");throw new Error(s?`${s}\n${i}`:i)}}_addComponent(t){var e;const s=t.getConstructor();return this.components.has(s)||(t.UNSAFE_setEntity(this),this.components.set(s,t),null===(e=this.scene)||void 0===e||e.UNSAFE_addComponent(t),this.emit("add-component",t)),this}_removeComponent(t){var e;const s=this.getComponent(t);return s&&(this.emit("remove-component",s),s.UNSAFE_removeEntity(),this.components.delete(t),null===(e=this.scene)||void 0===e||e.UNSAFE_removeComponent(s)),this}_addChild(t){var e,s,i;return-1===this.children.indexOf(t)&&(t.isRoot()&&(null===(e=t.scene)||void 0===e||e.removeEntity(t)),null===(s=t.parent)||void 0===s||s._removeChild(t),this.children.push(t),t.parent=this,t.root=this.root,t.setDepth(this.depth+1),null===(i=this.scene)||void 0===i||i.UNSAFE_addEntityNow(t,!0),this.emit("add-child",t)),this}_removeChild(t){var e;return null===(e=this.scene)||void 0===e||e.UNSAFE_removeEntityNow(t),this.UNSAFE_removeChild(t),this}UNSAFE_removeChild(t){const e=this.children.indexOf(t);return-1!==e&&(this.emit("remove-child",t),this.children.splice(e,1),t.scene=null,t.parent=null,t.root=t,t.setDepth(0)),this}setDepth(t){this.depth=t;for(const e of this.children)e.setDepth(t+1);return this}toJSON(){return Object.assign(Object.assign({},super.toJSON()),{name:this.name,tags:[...this.tags.values()],children:this.children.map((t=>t.toJSON())),components:[...this.components.values()].map((t=>t.toJSON()))})}fromJSON(t){return super.fromJSON(t),t.name&&(this.name=t.name),a(t.tags)&&this.addTags(t.tags),a(t.children)&&this.addChildren(t.children.map((t=>(new ue).fromJSON(t)))),a(t.components)&&this.addComponents(t.components.map((t=>m.newFromJSON(t)))),this}}class ce extends d{constructor(){super(...arguments),this.name=null,this.entities=[],this.entitiesToAdd=[],this.entitiesToRemove=[],this.managers=[],this.managerMap=new Map,this.plugins=[],this.pluginsMap=new Map,this.isUpdating=!1,this.isInitted=!1,this.sortPluginsFunction=(t,e)=>t.getPluginPriority()-e.getPluginPriority()}init(){if(!this.isInitted){this.isInitted=!0,this.emit("init"),this.maintain();for(const t of this.plugins)t.onInit();for(const t of this.managers)t.onInit();this.isInitted=!0}return this}maintain(t=!0){t&&this.emit("maintain");for(const t of this.entitiesToRemove)this.removeEntityNow(t,!0);this.entitiesToRemove.length=0;for(const t of this.entitiesToAdd)this.addEntityNow(t,!0);return this.entitiesToAdd.length=0,this}update(){this.init(),this.isUpdating=!0,this.emit("update"),this.maintain();for(const t of this.plugins)t.onUpdate();for(const t of this.managers)t.onUpdate();for(const t of this.managers)t.onAfterUpdate();for(const t of this.plugins)t.onAfterUpdate();return this.isUpdating=!1,this}clear(){return this.emit("clear"),this.removeEntities(this.entities),this.removePlugin(...this.pluginsMap.keys()),this}getName(){return this.name}setName(t){return this.name=t,this}removeName(){return this.name=null,this}forEachEntity(t,e=!0){for(const s of this.entities){if(!1===t(s))break;e&&s.forEachChild(t,e)}return this}find(t,e=!0){for(const s of this.entities){if(t(s))return s;if(e){const i=s.find(t,e);if(i)return i}}}findWithTag(...t){return this.find((e=>e.hasTags(t)),!0)}findWithTags(t){return this.findWithTag(...t)}findWithName(t){return this.find((e=>e.getName()===t),!0)}findAll(t,e=!0){const s=[];for(const i of this.entities)t(i)?s.push(i):e&&s.push(...i.findAll(t,e));return s}findAllWithTag(...t){return this.findAll((e=>e.hasTags(t)),!0)}findAllWithTags(t){return this.findAllWithTag(...t)}findAllWithName(t){return this.findAll((e=>e.getName()===t),!0)}getEntities(){return this.entities}getManagers(){return this.managers}getManager(t){return this.managerMap.get(t)||null}getRequiredManager(t){const e=this.getManager(t);if(!e)throw new Error(`Scene required ${t} Manager`);return e}getPlugins(){return this.plugins}hasPlugin(t){return null!==this.getPlugin(t)}getPlugin(t){return this.pluginsMap.get(t)||null}getRequiredPlugin(t){const e=this.getPlugin(t);if(!e)throw new Error(`Scene required ${t} Plugin`);return e}addPlugins(t){for(const e of t)this._addPlugin(e);return this.sortPlugins()}addPlugin(...t){return this.addPlugins(t)}removePlugins(t){for(const e of t)this._removePlugin(e);return this}removePlugin(...t){return this.removePlugins(t)}addEntities(t){return this.entitiesToAdd.push(...t),this}addEntity(...t){return this.addEntities(t)}removeEntities(t){return this.entitiesToRemove.push(...t),this}removeEntity(...t){return this.removeEntities(t)}addEntityNow(t,e=!1){if(this.isUpdating&&!e)throw new Error("Scene.addEntityNow called while updating, use force to suppress this Error");return this.UNSAFE_addEntityNow(t,!1)}removeEntityNow(t,e=!1){if(this.isUpdating&&!e)throw new Error("Scene.removeEntityNow called while updating, use force to suppress this Error");return this.UNSAFE_removeEntityNow(t)}UNSAFE_addComponent(t){const e=t.getManagerConstructor();let s=this.getManager(e);return s||(s=new e,s.UNSAFE_setScene(this),this.managers.push(s),this.managerMap.set(e,s),this.sortManagers(),s.onAdd()),s.addComponent(t),t.UNSAFE_setManager(s),s.sort(),t.onAdd(),t.emit("add-to-scene"),this.emit("add-component",t),this}UNSAFE_removeComponent(t){const e=t.getManagerConstructor(),s=this.getManager(e);return this.emit("remove-component",t),t.emit("remove-from-scene"),s&&(t.onRemove(),s.removeComponent(t),t.UNSAFE_removeManager(),s.isEmpty()&&(s.onRemove(),this.managers.splice(this.managers.indexOf(s),1),this.managerMap.delete(e))),this}UNSAFE_addEntityNow(t,e){const s=t.getScene();if(s){if(s===this)throw new Error("Scene trying to add an Entity that is already a member of the Scene");s.removeEntityNow(t,!0)}if(t.isRoot())this.entities.push(t);else if(!e)throw new Error("Scene trying to add an Entity that already has a parent");t.UNSAFE_setScene(this);for(const e of t.getComponents().values())this.UNSAFE_addComponent(e);for(const e of t.getChildren())this.UNSAFE_addEntityNow(e,!0);return this.emit("add-entity",t),this}UNSAFE_removeEntityNow(t){var e;const s=t.getScene();if(s&&s!==this)throw new Error("Scene trying to remove an Entity that is not a member of the Scene");for(const e of t.getComponents().values())this.UNSAFE_removeComponent(e);if(t.isRoot()){const e=this.entities.indexOf(t);-1!==e&&(this.entities.splice(e,1),t.UNSAFE_removeScene())}else null===(e=t.getParent())||void 0===e||e.UNSAFE_removeChild(t);for(const e of t.getChildren().slice())this.removeEntityNow(e,!0);return this.emit("remove-entity",t),this}_addPlugin(t){const e=t.getConstructor();if(!this.hasPlugin(e)){const e=t.getConstructor();this.plugins.push(t),this.pluginsMap.set(e,t),t.UNSAFE_setScene(this),this.isInitted&&t.onInit(),t.onAdd(),this.emit("add-plugin",t)}return this}_removePlugin(t){const e=this.getPlugin(t);return e&&(this.emit("remove-plugin",e),e.onRemove(),e.UNSAFE_removeScene(),this.plugins.splice(this.plugins.indexOf(e),1),this.pluginsMap.delete(t)),this}sortPlugins(){return this.plugins.sort(this.sortPluginsFunction),this}sortManagers(){return this.managers.sort(this.managerSortFunction),this}managerSortFunction(t,e){return t.getManagerPriority()-e.getManagerPriority()}toJSON(){return Object.assign(Object.assign({},super.toJSON()),{name:this.name||null,plugins:this.plugins.filter((t=>t.getConstructor().isToFromJSONEnabled())).map((t=>t.toJSON())),entities:this.entities.map((t=>t.toJSON()))})}fromJSON(t){return super.fromJSON(t),t.name&&(this.name=t.name),a(t.plugins)&&this.addPlugins(t.plugins.map((t=>ft.newFromJSON(t)))),a(t.entities)&&this.addEntities(t.entities.map((t=>(new ue).fromJSON(t)))),this.maintain(!1)}}class le extends d{constructor(){super(...arguments),this.width=1,this.height=1}getWidth(){return this.width}getHeight(){return this.height}setWidth(t){return this.set(t,this.height)}setHeight(t){return this.set(this.width,t)}set(t,e){const s=this.width,i=this.height;return t===s&&e===i||(this.width=t,this.height=e,this.onResize(),this.emit("resize",t,e,s,i)),this}}class de extends xt{getCtx(){return this.getRequiredRenderer().getCtx()}getCamera(){return this.getRequiredRenderer().getCamera()}getScale(){return this.getRequiredRenderer().getScale()}}de.rendererHandlerPriority=0;const ge=i.create();class pe extends de{onRender(){const t=this.getManager(S);if(t){const e=this.getRequiredRenderer(),s=e.getScale();for(const i of t.getComponents())i.getRenderable()&&e.render((t=>{t.beginPath(),t.strokeStyle="#0c0",t.moveTo(0,0),t.lineTo(0,.5),t.stroke(),t.beginPath(),t.strokeStyle="#00c",t.moveTo(0,0),t.lineTo(.5,0),t.stroke(),t.beginPath(),t.arc(0,0,2*s,0,2*Math.PI),t.fill()}),i.getMatrix2d(ge))}return this}}const me=i.create(),fe=N.create(),ve=N.create(),Se=t.create(),we=t.create();class ye extends de{onRender(){var t;const e=this.getManager(re);if(e){const s=this.getRequiredRenderer(),i=this.getCamera().getAABB2(fe),r=ve,n=Se,o=we;for(const a of e.getComponents()){const e=null===(t=a.getImageAsset())||void 0===t?void 0:t.getImage();if(a.getRenderable()&&e){const t=x.getRequiredTransform(a.getRequiredEntity());if(K(r,t.getPosition2(n),t.getRotationZ(),a.getSize(o)),N.notIntersects(i,r))continue;s.render((t=>{const s=a.getWidth(),i=a.getHeight(),r=.5*s,n=.5*i;t.scale(1,-1),t.drawImage(e,a.getClipX(),a.getClipY(),a.getClipWidth(),a.getClipHeight(),-r,-n,s,i)}),t.getMatrix2d(me))}}}return this}}const xe=i.create();class Ne extends Nt{constructor(t){super(),this.lineWidth=1,this.camera=null,this.cameraView=i.create(),this.cameraProjection=i.create(),this.cameraViewProjection=i.create(),this.scale=1,this.enabled=!0,this.element=t,this.ctx=t.getContext("2d")}getCameraView(){return this.cameraView}getCameraProjection(){return this.cameraProjection}getCameraViewProjection(){return this.cameraViewProjection}getElement(){return this.element}getCtx(){return this.ctx}getEnabled(){return this.enabled}setEnabled(t=!0){return this.enabled=t,this}getLineWidth(){return this.lineWidth}setLineWidth(t){return this.lineWidth=t,this}getActiveCamera(){return this.getRequiredScene().getRequiredManager(ht).getRequiredActive()}getCamera(){return this.camera||this.getActiveCamera()}setCamera(t){return this.camera=t,this}removeCamera(){return this.camera=null,this}getCanvasSize(){const t=this.element.width,e=this.element.height;return.5*(t>e?e:t)}getScale(){return this.scale}render(t,e){const s=xe;return e?i.mul(s,this.cameraViewProjection,e):i.copy(s,this.cameraViewProjection),this.ctx.save(),this.ctx.transform(s[0],s[1],s[2],s[3],s[4],s[5]),t(this.ctx),this.ctx.restore(),this}onUpdate(){if(!this.enabled)return this;const t=this.getCamera(),e=this.element.width,s=this.element.height,r=.5*e,n=.5*s;return t.set(e,s),i.copy(this.cameraView,t.getView()),i.copy(this.cameraProjection,t.getProjection()),i.mul(this.cameraViewProjection,this.cameraProjection,this.cameraView),this.scale=1/this.getCanvasSize()*t.getZoom(),this.ctx.save(),this.ctx.save(),this.ctx.fillStyle=Y(t.getBackground()),this.ctx.fillRect(0,0,e,s),this.ctx.restore(),this.ctx.lineWidth=this.getLineWidth()*this.getScale(),this.ctx.transform(r,0,0,-n,r,n),super.onUpdate(),this.ctx.restore(),this}toJSON(){return Object.assign(Object.assign({},super.toJSON()),{lineWidth:this.lineWidth,enabled:this.enabled})}fromJSON(t){return super.fromJSON(t),this.lineWidth=t.lineWidth,this.enabled=t.enabled,this}}Ne.toFromJSONEnabled=!1;class Pe extends yt{constructor(t){super(),this.image=null,this.src=t}getImage(){return this.image}getWidth(){var t,e;return null!==(e=null===(t=this.image)||void 0===t?void 0:t.width)&&void 0!==e?e:0}getHeight(){var t,e;return null!==(e=null===(t=this.image)||void 0===t?void 0:t.height)&&void 0!==e?e:0}loadAsset(){return new Promise(((t,e)=>{const s=new Image;s.addEventListener("load",(()=>{this.image=s,t()})),s.addEventListener("error",(t=>e(t))),s.src=this.src}))}unloadAsset(){return this.image=null,Promise.resolve()}toJSON(){return Object.assign(Object.assign({},super.toJSON()),{src:this.src})}fromJSON(t){return super.fromJSON(t),this.src=t.src,this}}class Ee extends At{constructor(t){super(),this.touchInputEventPool=new h(Ht,Ht.init),this.mouseInputEventPool=new h(Ft,Ft.init),this.mouseWheelInputEventPool=new h(jt,jt.init),this.keyboardInputEventPool=new h(_t,_t.init),this.resizeInputEventPool=new h(Jt,Jt.init),this.onResize=()=>{const t=this.resizeInputEventPool.create("resize");t.width=this.window.innerWidth,t.height=this.window.innerHeight,this.queueEvent(t)},this.onTouch=t=>{const e=t,s=this.element.getBoundingClientRect();for(let t=0,i=e.touches.length;t<i;t++){const i=e.touches[t],r=i.clientX-s.left,n=i.clientY-s.top,o=this.touchInputEventPool.create(e.type);o.id=i.identifier,o.x=r,o.y=n,this.queueEvent(o)}},this.onMouse=t=>{const e=t,s=this.element.getBoundingClientRect(),i=e.clientX-s.left,r=e.clientY-s.top,n=this.mouseInputEventPool.create(e.type);n.button=e.button,n.x=i,n.y=r,this.queueEvent(n)},this.onMouseWheel=t=>{const e=t,s=this.mouseWheelInputEventPool.create(e.type);s.wheel=e.deltaY,this.queueEvent(s)},this.onKeyboard=t=>{const e=t,s=this.keyboardInputEventPool.create(e.type);s.code=e.code,this.queueEvent(s)},this.element=t,this.window=t.ownerDocument.defaultView}onAdd(){return this.window.addEventListener("orientationchange",this.onResize),this.window.addEventListener("resize",this.onResize),this.element.addEventListener("touchstart",this.onTouch),this.element.addEventListener("touchmove",this.onTouch),this.element.addEventListener("touchend",this.onTouch),this.element.addEventListener("touchcancel",this.onTouch),this.element.addEventListener("mousemove",this.onMouse),this.element.addEventListener("mousedown",this.onMouse),this.element.addEventListener("mouseup",this.onMouse),this.element.addEventListener("wheel",this.onMouseWheel),this.element.addEventListener("mouseleave",this.onMouse),this.element.addEventListener("keydown",this.onKeyboard),this.element.addEventListener("keyup",this.onKeyboard),this.onResize(),this}onRemove(){return this.window.removeEventListener("orientationchange",this.onResize),this.window.removeEventListener("resize",this.onResize),this.element.removeEventListener("touchstart",this.onTouch),this.element.removeEventListener("touchmove",this.onTouch),this.element.removeEventListener("touchend",this.onTouch),this.element.removeEventListener("touchcancel",this.onTouch),this.element.removeEventListener("mousemove",this.onMouse),this.element.removeEventListener("mousedown",this.onMouse),this.element.removeEventListener("mouseup",this.onMouse),this.element.removeEventListener("wheel",this.onMouseWheel),this.element.removeEventListener("mouseleave",this.onMouse),this.element.removeEventListener("keydown",this.onKeyboard),this.element.removeEventListener("keyup",this.onKeyboard),this}dequeueEvent(t){return t instanceof Ft?(this.mouseInputEventPool.release(t),!0):t instanceof _t?(this.keyboardInputEventPool.release(t),!0):t instanceof jt?(this.mouseWheelInputEventPool.release(t),!0):t instanceof Ht&&(this.touchInputEventPool.release(t),!0)}}Ee.toFromJSONEnabled=!1;class Ae extends le{constructor(t){super(),this.canvas=t||document.createElement("canvas"),this.set(this.canvas.width,this.canvas.height)}getElement(){return this.canvas}onResize(){return this.canvas.width=this.getWidth(),this.canvas.height=this.getHeight(),this.canvas.style.width=`${this.getWidth()}px`,this.canvas.style.height=`${this.getHeight()}px`,this}getImageURI(){return this.canvas.toDataURL("image/png").replace("image/png","image/octet-stream")}getStream(t=60){return this.canvas.captureStream(t)}}export{gt as Asset,vt as Assets,dt as Camera2D,Gt as Camera2DControl,Vt as Camera2DControlManager,ht as Camera2DManager,ie as Camera3D,te as Camera3DManager,le as Canvas,m as Component,Ne as CtxRenderer,de as CtxRendererHandler,P as DEG_TO_RAD,v as DefaultDescriptorManager,p as DefaultManager,R as EPSILON,ue as Entity,At as EventListener,Wt as EventLoop,Tt as FullScreenCanvas,A as HALF_PI,yt as ImageAsset,qt as Input,Ct as InputAxis,Rt as InputButton,It as InputEvent,Ot as InputHandler,St as JSONAsset,c as JSONClassRegistry,_t as KeyboardInputEvent,Lt as KeyboardInputHandler,$t as Loop,g as Manager,Ft as MouseInputEvent,Mt as MouseInputHandler,jt as MouseWheelInputEvent,ft as Plugin,E as RAD_TO_DEG,wt as RawJSONAsset,f as RenderableComponent,Nt as Renderer,xt as RendererHandler,Jt as ResizeInputEvent,bt as ResizeInputHandler,he as RunOnUpdateComponent,Et as RunOnUpdatePlugin,ce as Scene,ne as Sprite,oe as SpriteClip,ye as SpriteCtxRendererHandler,re as SpriteManager,ae as SpriteSheet,C as TAU,Pt as Time,d as ToFromJSONEventEmitter,Ht as TouchInputEvent,Ut as TouchInputHandler,st as Transform2D,at as Transform3D,x as TransformComponent,S as TransformComponentManager,pe as TransformCtxRendererHandler,Ae as WebCanvas,Ee as WebEventListener,Pe as WebImageAsset,T as angleVec2,kt as cancelAnimationFrame,H as clamp,O as composeMat2d,U as decomposeMat2d,k as degToRad,W as equals,pt as filterRequirements,K as getAABB2FromRect,j as getAngleBetweenPoints,I as getAngleFromPoint,q as getPointFromAngle,b as getRotationFromMat2d,F as getTangentAngle,l as globalJSONClassRegistry,z as projectPointOnAxis,D as radToDeg,Dt as requestAnimationFrame,mt as requirementToString,J as sign,$ as toHex,V as toRgb,Y as toRgba,B as vec2FromAngle};
//# sourceMappingURL=index.js.map
